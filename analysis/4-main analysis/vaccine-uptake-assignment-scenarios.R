########################################################################################################################
#Title: Vaccine uptake scenarios
#Author: Hailey Park
#Date: January 16th, 2025
########################################################################################################################

#Vaccination assignment under historical coverage
# NOTE: This function assigns which individuals in the population will receive vaccines (`vax_1`, `vax_2`, `vax_3`) and timing of those doses 
#       (`vaccine_wave`, `second_vaccine_wave`, `third_vaccine_wave`) based on historical age/risk-specific vaccine administration data. 
#       Individuals who receive the semi-annual dose (`vax_2`) are only in the 65+ years and immunocompromised groups based on coverage estimates. 
historical_vax_assignment <- function(df, first_dose_data, second_dose_data, next_year_dose_data, realistic_ind){
  
  #Assign who is getting vaccinated using age-specific and risk-specific coverage rates
  # NOTE: `vax_1`, `vax_2`, `vax_3` assigns who will get 1st, 2nd, or 3rd doses based on historic coverage rates.
  #       `vaccine_wave`, `second_vaccine_wave`, `third_vaccine_wave` assigns when those doses are administered based on historic uptake
  vax_assignment <- df %>% mutate(vax_1 = 0, vax_2 = 0, vax_3 = 0, vaccine_wave = 0, second_vaccine_wave = 0, third_vaccine_wave = 0)
  
  #For 0-17 years age bin, assume that 96.7% of 0-17 years are older than 6 months (CRUDE ASSUMPTION)
  age_0_17_index <- which(vax_assignment$age_group == "0-17 years")
  age_0_17_index <- sample(age_0_17_index, length(age_0_17_index) * 0.967)
  
  age_18_29_index <- which(vax_assignment$age_group == "18-29 years")
  age_30_49_index <- which(vax_assignment$age_group == "30-49 years")
  age_50_64_index <- which(vax_assignment$age_group == "50-64 years")
  age_65_74_index <- which(vax_assignment$age_group == "65-74 years")
  age_75_plus_index <- which(vax_assignment$age_group == "75+ years")
  
  risk_healthy_index <- which(vax_assignment$risk_group == "healthy")
  risk_highrisk_index <- which(vax_assignment$risk_group == "higher risk")
  risk_immuno_index <- which(vax_assignment$risk_group == "immunocompromised")
  
  prev_vaccinated <- which(vax_assignment$prior_vacc != "unvax")
  
  #Assign who will receive first vaccine dose
  # NOTE: Only individuals who have been previously vaccinated are eligible for the first vaccine dose. Since we are sampling only from individuals who have been previously
  #       vaccinated but we are trying to hit the age/risk-specific coverage targets for the entire age/risk group (including those previously unvaccinated), we adjust
  #       the coverage upwards for the probability in the rbinom function.
  vax_assignment$vax_1[Reduce(intersect, list(age_0_17_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_0_17_index,risk_healthy_index,prev_vaccinated))), 1, 0.13 * length(Reduce(intersect, list(age_0_17_index,risk_healthy_index)))/length(Reduce(intersect, list(age_0_17_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_0_17_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index,prev_vaccinated))), 1, 0.235 * length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_0_17_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,prev_vaccinated))), 1, 0.235 * length(Reduce(intersect, list(age_0_17_index,risk_immuno_index)))/length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,prev_vaccinated))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_18_29_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,prev_vaccinated))), 1, 0.0926 * length(Reduce(intersect, list(age_18_29_index,risk_healthy_index)))/length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,prev_vaccinated))), 1, 0.1668 * length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated))), 1, 0.1668 * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,prev_vaccinated))), 1, 0.1308 * length(Reduce(intersect, list(age_30_49_index,risk_healthy_index)))/length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated))), 1, 0.2355 * length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))), 1, 0.2355 * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,prev_vaccinated))), 1, 0.1439 * length(Reduce(intersect, list(age_50_64_index,risk_healthy_index)))/length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,prev_vaccinated))), 1, 0.2591 * length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))), 1, 0.2591 * length(Reduce(intersect, list(age_50_64_index,risk_immuno_index)))/length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))), 1, 0.2228 * length(Reduce(intersect, list(age_65_74_index,risk_healthy_index)))/length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))), 1, 0.4010 * length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))), 1, 0.4010 * length(Reduce(intersect, list(age_65_74_index,risk_immuno_index)))/length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))), 1, 0.221 * length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))), 1, 0.3979 * length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))), 1, 0.3979 * length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))))
  
  print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
  print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
  print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
  print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
  print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
  print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
  print("0.15, 0.113, 0.1596, 0.217, 0.3794, 0.3764")
  
  print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy"))* 0.967)))
  print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
  
  print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
  print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
  
  print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
  print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
  
  #Assign who is getting the second vaccine dose 
  # NOTE: Only individuals who have already been assigned with receiving the first vaccine dose `vax_1` are eligible for the second vaccine dose. Since we are sampling only
  #       from individuals who have been assigned first vaccine dose but we are trying to hit the age/risk-specific coverage targets for the entire age/risk group 
  #       (including those who aren't eligible for the second dose), we adjust the coverage upwards for the probability in the rbinom function.
  second_dose_eligible <- which(vax_assignment$vax_1 == 1)
  vax_assignment$vax_2[Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))), 1, 0.054 * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))))
  vax_assignment$vax_2[Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))), 1, 0.054 * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))))
  vax_assignment$vax_2[Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))), 1, 0.054 * length(Reduce(intersect, list(age_50_64_index,risk_immuno_index)))/length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))))
  
  vax_assignment$vax_2[Reduce(intersect, list(age_65_74_index, second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_65_74_index, second_dose_eligible))), 1, 0.089 * length(Reduce(intersect, list(age_65_74_index)))/length(Reduce(intersect, list(age_65_74_index,second_dose_eligible))))
  vax_assignment$vax_2[Reduce(intersect, list(age_75_plus_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index, second_dose_eligible))), 1, 0.089 * length(Reduce(intersect, list(age_75_plus_index)))/length(Reduce(intersect, list(age_75_plus_index,second_dose_eligible))))
  
  print(paste0("Percentage of immunocompromised receiving second dose: ",  length(which(vax_assignment$risk_group %in% c("immunocompromised") & vax_assignment$vax_2 == 1))/length(which(vax_assignment$risk_group %in% c("immunocompromised")))))
  print(paste0("Percentage of 65-74 years receiving second dose: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_2 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
  print(paste0("Percentage of 75+ years receiving second dose: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_2 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
  
  #Assign who will receive the third vaccine dose (filter first among individuals who have already been assigned with receiving second vaccine dose `vax_2`, then filter among those who received first vaccine dose `vax_1`)
  # NOTE: Only individuals who have been previously vaccinated are eligible for the third vaccine dose. We filter first among individuals who have already been assigned with receiving second vaccine dose `vax_2`, 
  #       then filter among those who received first vaccine dose `vax_1`, then among all previously vaccinated individuals. We adjust the coverage upwards for the probability in the rbinom function.
  third_dose_eligible <- which(vax_assignment$vax_2 == 1)
  
  vax_assignment$vax_3[Reduce(intersect, list(age_0_17_index,risk_healthy_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_0_17_index,risk_healthy_index,second_dose_eligible))), 1, 0.1194 * length(Reduce(intersect, list(age_0_17_index,risk_healthy_index)))/length(Reduce(intersect, list(age_0_17_index,risk_healthy_index,second_dose_eligible))))
  vax_assignment$vax_3[Reduce(intersect, list(age_0_17_index,risk_highrisk_index,second_dose_eligible))] <- 1
  vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_0_17_index,risk_highrisk_index)), second_dose_eligible), round(length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index))) * (0.2397 - 0.235)))] <- 1
  vax_assignment$vax_3[Reduce(intersect, list(age_0_17_index,risk_immuno_index,second_dose_eligible))] <- 1
  vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_0_17_index,risk_immuno_index)), second_dose_eligible), round(length(Reduce(intersect, list(age_0_17_index,risk_immuno_index))) * (0.2397 - 0.235)))] <- 1
  
  vax_assignment$vax_3[Reduce(intersect, list(age_18_29_index,risk_healthy_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,second_dose_eligible))), 1, 0.0758 * length(Reduce(intersect, list(age_18_29_index,risk_healthy_index)))/length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,second_dose_eligible))))
  vax_assignment$vax_3[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,third_dose_eligible))] <- 1
  vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_18_29_index,risk_highrisk_index, second_dose_eligible)), third_dose_eligible), round(length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index)))  * (0.1521 + 0.05 - 0.054)))] <- 1
  vax_assignment$vax_3[Reduce(intersect, list(age_18_29_index,risk_immuno_index,third_dose_eligible))] <- 1#
  vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_18_29_index,risk_immuno_index, second_dose_eligible)), third_dose_eligible), round(length(Reduce(intersect, list(age_18_29_index,risk_immuno_index))) * (0.1521 - 0.054)))] <- 1
  
  vax_assignment$vax_3[Reduce(intersect, list(age_30_49_index,risk_healthy_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,second_dose_eligible))), 1, 0.121 * length(Reduce(intersect, list(age_30_49_index,risk_healthy_index)))/length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,second_dose_eligible))))
  vax_assignment$vax_3[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,second_dose_eligible))] <- 1
  vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)), second_dose_eligible), round(length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index))) * (0.2428 - 0.2355)))] <- 1
  vax_assignment$vax_3[Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))] <- 1
  vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_30_49_index,risk_immuno_index)), second_dose_eligible), round(length(Reduce(intersect, list(age_30_49_index,risk_immuno_index))) * (0.2428 - 0.2355)))] <- 1
  
  
  vax_assignment$vax_3[Reduce(intersect, list(age_50_64_index,risk_healthy_index,second_dose_eligible))] <- 1
  vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_50_64_index,risk_healthy_index)), second_dose_eligible), round(length(Reduce(intersect, list(age_50_64_index,risk_healthy_index))) * (0.1471 - 0.1439)))] <- 1
  vax_assignment$vax_3[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,second_dose_eligible))] <- 1
  vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_50_64_index,risk_highrisk_index)), second_dose_eligible), round(length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index))) * (0.2953 - 0.2591)))] <- 1
  vax_assignment$vax_3[Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))] <- 1
  vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_50_64_index,risk_immuno_index)), second_dose_eligible), round(length(Reduce(intersect, list(age_50_64_index,risk_immuno_index))) * (0.2953 - 0.2591)))] <- 1
  
  vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_healthy_index,second_dose_eligible))] <- 1
  vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_healthy_index)), second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_healthy_index)), second_dose_eligible)) * (0.2334 - 0.2228)))] <- 1
  vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,second_dose_eligible))] <- 1
  vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)), second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)), second_dose_eligible)) * (0.4685 - 0.3710)))] <- 1
  vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_immuno_index,second_dose_eligible))] <- 1
  vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_immuno_index)), second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_immuno_index)), second_dose_eligible)) * (0.4685 - 0.3710)))] <- 1
  
  vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,second_dose_eligible))] <- 1
  vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)), second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)), second_dose_eligible)) * (0.254 - 0.221)))] <- 1
  vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,second_dose_eligible))] <- 1
  vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)), second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)), second_dose_eligible)) * (0.5097 - 0.3379)))] <- 1
  vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,second_dose_eligible))] <- 1
  vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)), second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)), second_dose_eligible)) * (0.5097 - 0.3379)))] <- 1

  print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
  print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
  print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
  print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
  print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
  print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
  
  print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy")) * 0.967)))
  print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
  print("0.1336, 0.0967, 0.1543, 0.2411, 0.4393, 0.478")
  
  print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
  print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
  
  print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
  print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
  
  #distribute first vaccine dose over first 365 days, according to age-specific distribution of historic coverage
  to_vaccinate_index <- which(vax_assignment$vax_1 == 1)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_0_17_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  #distribute second vaccine dose over 240-365 days of simulation, according to age-specific distribution of historic coverage
  to_vaccinate_second_index <- which(vax_assignment$vax_2 == 1)
  
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  #distribute third vaccine dose last 182 days of simulation, according to age-specific distribution of historic coverage
  to_vaccinate_third_index <- which(vax_assignment$vax_3 == 1)
  
  vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_0_17_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "0-17 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "0-17 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "0-17 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "18-29 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "18-29 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "30-49 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  return(vax_assignment %>% arrange(individual))
}


#Strategy 0: No vaccination
strategy_0 <- function(df, first_dose_data, second_dose_data, next_year_dose_data, realistic_ind){
  
  #Assign who is getting vaccinated using age-specific and risk-specific coverage rates
  # NOTE: `vax_1`, `vax_2`, `vax_3` assigns who will get 1st, 2nd, or 3rd doses based on assumed coverage rates.
  #       `vaccine_wave`, `second_vaccine_wave`, `third_vaccine_wave` assigns when those doses are administered based on assumed uptake
  vax_assignment <- df %>% mutate(vax_1 = 0, vax_2 = 0, vax_3 = 0, vaccine_wave = 0, second_vaccine_wave = 0, third_vaccine_wave = 0)
  
  return(vax_assignment %>% arrange(individual))
}

#Strategy 1: Annual vaccine to 6 months and older
strategy_1 <- function(df, first_dose_data, second_dose_data, next_year_dose_data, realistic_ind){
  
  #Assign who is getting vaccinated using age-specific and risk-specific coverage rates
  # NOTE: `vax_1`, `vax_2`, `vax_3` assigns who will get 1st, 2nd, or 3rd doses based on assumed coverage rates.
  #       `vaccine_wave`, `second_vaccine_wave`, `third_vaccine_wave` assigns when those doses are administered based on assumed uptake
  vax_assignment <- df %>% mutate(vax_1 = 0, vax_2 = 0, vax_3 = 0, vaccine_wave = 0, second_vaccine_wave = 0, third_vaccine_wave = 0)
  
  #Pull coverage rates from first dose data
  first_dose_coverage <- (first_dose_data %>% filter(week == 52) %>% arrange(age_group, risk_group))$risk_coverage/100
  
  #For 0-17 years age bin, assume that 96.7% of 0-17 years are older than 6 months (CRUDE ASSUMPTION)
  age_0_17_index <- which(vax_assignment$age_group == "0-17 years")
  age_0_17_index <- sample(age_0_17_index, length(age_0_17_index) * 0.967)
  
  age_18_29_index <- which(vax_assignment$age_group == "18-29 years")
  age_30_49_index <- which(vax_assignment$age_group == "30-49 years")
  age_50_64_index <- which(vax_assignment$age_group == "50-64 years")
  age_65_74_index <- which(vax_assignment$age_group == "65-74 years")
  age_75_plus_index <- which(vax_assignment$age_group == "75+ years")
  
  risk_healthy_index <- which(vax_assignment$risk_group == "healthy")
  risk_highrisk_index <- which(vax_assignment$risk_group == "higher risk")
  risk_immuno_index <- which(vax_assignment$risk_group == "immunocompromised")
  
  prev_vaccinated <- which(vax_assignment$prior_vacc != "unvax")
  
  #Assign who will receive first vaccine dose
  # NOTE: Only individuals who have been previously vaccinated are eligible for the first vaccine dose. Since we are sampling only from individuals who have been previously
  #       vaccinated but we are trying to hit the age/risk-specific coverage targets for the entire age/risk group (including those previously unvaccinated), we adjust
  #       the coverage upwards for the probability in the rbinom function.
  vax_assignment$vax_1[Reduce(intersect, list(age_0_17_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_0_17_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[1] * length(Reduce(intersect, list(age_0_17_index,risk_healthy_index)))/length(Reduce(intersect, list(age_0_17_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_0_17_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index,prev_vaccinated))), 1, if_else(first_dose_coverage[2] * length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index,prev_vaccinated))) > 1, 1, first_dose_coverage[2] * length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index,prev_vaccinated)))))
  vax_assignment$vax_1[Reduce(intersect, list(age_0_17_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,prev_vaccinated))), 1, if_else(first_dose_coverage[3] * length(Reduce(intersect, list(age_0_17_index,risk_immuno_index)))/length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,prev_vaccinated))) > 1, 1, first_dose_coverage[3] * length(Reduce(intersect, list(age_0_17_index,risk_immuno_index)))/length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,prev_vaccinated)))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_18_29_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[4] * length(Reduce(intersect, list(age_18_29_index,risk_healthy_index)))/length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,prev_vaccinated))), 1, if_else(first_dose_coverage[5] * length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,prev_vaccinated))) > 1, 1, first_dose_coverage[5] * length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,prev_vaccinated)))))
  vax_assignment$vax_1[Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated))), 1, if_else(first_dose_coverage[6] * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated))) > 1, 1, first_dose_coverage[6] * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated)))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[7] * length(Reduce(intersect, list(age_30_49_index,risk_healthy_index)))/length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated))), 1, if_else(first_dose_coverage[8] * length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated))) > 1, 1, first_dose_coverage[8] * length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated)))))
  vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))), 1, if_else(first_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))) > 1, 1, first_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated)))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[10] * length(Reduce(intersect, list(age_50_64_index,risk_healthy_index)))/length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[11] * length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[12] * length(Reduce(intersect, list(age_50_64_index,risk_immuno_index)))/length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[13] * length(Reduce(intersect, list(age_65_74_index,risk_healthy_index)))/length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[14] * length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[15] * length(Reduce(intersect, list(age_65_74_index,risk_immuno_index)))/length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[16] * length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[17] * length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[18] * length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))))
  
  print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
  print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
  print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
  print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
  print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
  print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
  
  print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy"))* 0.967)))
  print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
  
  print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
  print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
  
  print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
  print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
  
  
  #distribute first vaccine dose over first 365 days, according to age-specific distribution of assumed coverage
  to_vaccinate_index <- which(vax_assignment$vax_1 == 1)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_0_17_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  #For assignment of annual dose in year 2 of simulation, uptake assignment code differs depending on if assumed coverage is HISTORIC vs. OPTIMISTIC/PESSIMISTIC.
  # NOTE: If coverage is HISTORIC (`realistic_ind == 1`), then vaccine assignment for annual dose in year 2 is done more carefully since historic coverage is different in year 1 vs. 2.
  #       If coverage is OPTIMISTIC/PESSIMISTIC (`realistic_ind == 0`), then all individuals assigned to receive annual dose in year 1 are re-assigned to receive annual dose in year 2.
  if(realistic_ind == 1) {
    
    second_dose_eligible <- which(vax_assignment$vax_1 == 1)
    
    vax_assignment$vax_3[Reduce(intersect, list(age_0_17_index,risk_healthy_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_0_17_index,risk_healthy_index,second_dose_eligible))), 1, 0.1194 * length(Reduce(intersect, list(age_0_17_index,risk_healthy_index)))/length(Reduce(intersect, list(age_0_17_index,risk_healthy_index,second_dose_eligible))))
    vax_assignment$vax_3[Reduce(intersect, list(age_0_17_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_0_17_index,risk_highrisk_index)), second_dose_eligible), round(length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index))) * (0.2397 - 0.235)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_0_17_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_0_17_index,risk_immuno_index)), second_dose_eligible), round(length(Reduce(intersect, list(age_0_17_index,risk_immuno_index))) * (0.2397 - 0.235)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_18_29_index,risk_healthy_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,second_dose_eligible))), 1, 0.0758 * length(Reduce(intersect, list(age_18_29_index,risk_healthy_index)))/length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,second_dose_eligible))))
    vax_assignment$vax_3[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,second_dose_eligible))), 1, 0.1521 * length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,second_dose_eligible))))
    vax_assignment$vax_3[Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))), 1, 0.1521 * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))))
    
    vax_assignment$vax_3[Reduce(intersect, list(age_30_49_index,risk_healthy_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,second_dose_eligible))), 1, 0.121 * length(Reduce(intersect, list(age_30_49_index,risk_healthy_index)))/length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,second_dose_eligible))))
    vax_assignment$vax_3[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)), second_dose_eligible), round(length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index))) * (0.2428 - 0.2355)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_30_49_index,risk_immuno_index)), second_dose_eligible), round(length(Reduce(intersect, list(age_30_49_index,risk_immuno_index))) * (0.2428 - 0.2355)))] <- 1
    
    
    vax_assignment$vax_3[Reduce(intersect, list(age_50_64_index,risk_healthy_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_50_64_index,risk_healthy_index)), second_dose_eligible), round(length(Reduce(intersect, list(age_50_64_index,risk_healthy_index))) * (0.1471 - 0.1439)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_50_64_index,risk_highrisk_index)), second_dose_eligible), round(length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index))) * (0.2953 - 0.2591)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_50_64_index,risk_immuno_index)), second_dose_eligible), round(length(Reduce(intersect, list(age_50_64_index,risk_immuno_index))) * (0.2953 - 0.2591)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_healthy_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_healthy_index)), second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_healthy_index)), second_dose_eligible)) * (0.2334 - 0.2228)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)), second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)), second_dose_eligible)) * (0.4685 - 0.3710)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_immuno_index)), second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_immuno_index)), second_dose_eligible)) * (0.4685 - 0.3710)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)), second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)), second_dose_eligible)) * (0.254 - 0.221)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)), second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)), second_dose_eligible)) * (0.5097 - 0.3379)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)), second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)), second_dose_eligible)) * (0.5097 - 0.3379)))] <- 1
    
    print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
    print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
    print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
    print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
    print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
    print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years"))))

    print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy")) * 0.967)))
    print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
    
    print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
    print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
    
    print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
    print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
    
    #distribute vaccine uptake over last 182 days, according to age distributions
    to_vaccinate_third_index <- which(vax_assignment$vax_3 == 1)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_0_17_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "0-17 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "0-17 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "0-17 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "18-29 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "18-29 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "30-49 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
  } 
  
  if(realistic_ind == 0){
    print("Optimistic or Pessimistic uptake")
    vax_assignment$vax_3 <- vax_assignment$vax_1
    vax_assignment$third_vaccine_wave <- if_else(vax_assignment$vax_3 == 1, vax_assignment$vaccine_wave + 365, 0)
    
    print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
    print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
    print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
    print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
    print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
    print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years"))))

    print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy"))* 0.967)))
    print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
    
    print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
    print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
    
    print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
    print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
  }
    
  return(vax_assignment %>% arrange(individual))
}

#Strategy 2: Annual vaccine to 18 years and older
strategy_2 <- function(df, first_dose_data, second_dose_data, next_year_dose_data, realistic_ind){
  
  #Assign who is getting vaccinated using age-specific and risk-specific coverage rates
  # NOTE: `vax_1`, `vax_2`, `vax_3` assigns who will get 1st, 2nd, or 3rd doses based on assumed coverage rates.
  #       `vaccine_wave`, `second_vaccine_wave`, `third_vaccine_wave` assigns when those doses are administered based on assumed uptake
  vax_assignment <- df %>% mutate(vax_1 = 0, vax_2 = 0, vax_3 = 0, vaccine_wave = 0, second_vaccine_wave = 0, third_vaccine_wave = 0)
  
  #Pull coverage rates from first dose data
  first_dose_coverage <- (first_dose_data %>% filter(week == 52) %>% arrange(age_group, risk_group))$risk_coverage/100
  
  #For 0-17 years age bin, assume that 96.7% of 0-17 years are older than 6 months (CRUDE ASSUMPTION)
  age_0_17_index <- which(vax_assignment$age_group == "0-17 years")
  age_0_17_index <- sample(age_0_17_index, length(age_0_17_index) * 0.967)
  
  age_18_29_index <- which(vax_assignment$age_group == "18-29 years")
  age_30_49_index <- which(vax_assignment$age_group == "30-49 years")
  age_50_64_index <- which(vax_assignment$age_group == "50-64 years")
  age_65_74_index <- which(vax_assignment$age_group == "65-74 years")
  age_75_plus_index <- which(vax_assignment$age_group == "75+ years")
  
  risk_healthy_index <- which(vax_assignment$risk_group == "healthy")
  risk_highrisk_index <- which(vax_assignment$risk_group == "higher risk")
  risk_immuno_index <- which(vax_assignment$risk_group == "immunocompromised")
  
  prev_vaccinated <- which(vax_assignment$prior_vacc != "unvax")
  
  vax_assignment$vax_1[Reduce(intersect, list(age_18_29_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[4] * length(Reduce(intersect, list(age_18_29_index,risk_healthy_index)))/length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,prev_vaccinated))), 1, if_else(first_dose_coverage[5] * length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,prev_vaccinated))) > 1, 1, first_dose_coverage[5] * length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,prev_vaccinated)))))
  vax_assignment$vax_1[Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated))), 1, if_else(first_dose_coverage[6] * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated))) > 1, 1, first_dose_coverage[6] * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated)))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[7] * length(Reduce(intersect, list(age_30_49_index,risk_healthy_index)))/length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated))), 1, if_else(first_dose_coverage[8] * length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated))) > 1, 1, first_dose_coverage[8] * length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated)))))
  vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))), 1, if_else(first_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))) > 1, 1, first_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated)))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[10] * length(Reduce(intersect, list(age_50_64_index,risk_healthy_index)))/length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[11] * length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[12] * length(Reduce(intersect, list(age_50_64_index,risk_immuno_index)))/length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[13] * length(Reduce(intersect, list(age_65_74_index,risk_healthy_index)))/length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[14] * length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[15] * length(Reduce(intersect, list(age_65_74_index,risk_immuno_index)))/length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[16] * length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[17] * length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[18] * length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))))
  
  print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
  print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
  print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
  print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
  print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
  print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
  
  print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy"))* 0.967)))
  print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
  
  print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
  print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
  
  print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
  print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
  
  #Assign who is getting the second vaccine dose 
  # NOTE: Only individuals who have already been assigned with receiving the first vaccine dose `vax_1` are eligible for the second vaccine dose. Since we are sampling only
  #       from individuals who have been assigned first vaccine dose but we are trying to hit the age/risk-specific coverage targets for the entire age/risk group 
  #       (including those who aren't eligible for the second dose), we adjust the coverage upwards for the probability in the rbinom function.
  print(paste0("Percentage of immunocompromised receiving second dose: ",  length(which(vax_assignment$risk_group %in% c("immunocompromised") & vax_assignment$vax_2 == 1))/length(which(vax_assignment$risk_group %in% c("immunocompromised")))))
  print(paste0("Percentage of 65-74 years receiving second dose: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_2 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
  print(paste0("Percentage of 75+ years receiving second dose: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_2 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
  
  #distribute first vaccine dose over first 365 days, according to age-specific distribution of assumed coverage
  to_vaccinate_index <- which(vax_assignment$vax_1 == 1)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  #For assignment of annual dose in year 2 of simulation, uptake assignment code differs depending on if assumed coverage is HISTORIC vs. OPTIMISTIC/PESSIMISTIC.
  # NOTE: If coverage is HISTORIC (`realistic_ind == 1`), then vaccine assignment for annual dose in year 2 is done more carefully since historic coverage is different in year 1 vs. 2.
  #       If coverage is OPTIMISTIC/PESSIMISTIC (`realistic_ind == 0`), then all individuals assigned to receive annual dose in year 1 are re-assigned to receive annual dose in year 2.
  if(realistic_ind == 1) {
    
    second_dose_eligible <- which(vax_assignment$vax_1 == 1)
    
    vax_assignment$vax_3[Reduce(intersect, list(age_18_29_index,risk_healthy_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,second_dose_eligible))), 1, 0.0758 * length(Reduce(intersect, list(age_18_29_index,risk_healthy_index)))/length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,second_dose_eligible))))
    vax_assignment$vax_3[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,second_dose_eligible))), 1, 0.1521 * length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,second_dose_eligible))))
    vax_assignment$vax_3[Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))), 1, 0.1521 * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))))
    
    vax_assignment$vax_3[Reduce(intersect, list(age_30_49_index,risk_healthy_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,second_dose_eligible))), 1, 0.121 * length(Reduce(intersect, list(age_30_49_index,risk_healthy_index)))/length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,second_dose_eligible))))
    vax_assignment$vax_3[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index))) * (0.2428 - 0.2355)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_30_49_index,risk_immuno_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_30_49_index,risk_immuno_index))) * (0.2428 - 0.2355)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_50_64_index,risk_healthy_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_50_64_index,risk_healthy_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_50_64_index,risk_healthy_index))) * (0.1471 - 0.1439)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_50_64_index,risk_highrisk_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index))) * (0.2953 - 0.2591)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_50_64_index,risk_immuno_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_50_64_index,risk_immuno_index))) * (0.2953 - 0.2591)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_healthy_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_healthy_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_healthy_index)),second_dose_eligible)) * (0.2334 - 0.2228)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)),second_dose_eligible)) * (0.4685 - 0.3710)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_immuno_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_immuno_index)),second_dose_eligible)) * (0.4685 - 0.3710)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)),second_dose_eligible)) * (0.254 - 0.221)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)),second_dose_eligible)) * (0.5097 - 0.3379)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)),second_dose_eligible)) * (0.5097 - 0.3379)))] <- 1
    
    print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
    print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
    print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
    print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
    print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
    print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
    
    print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy")) * 0.967)))
    print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
    
    print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
    print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
    
    print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
    print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
    
    #distribute vaccine uptake over last 182 days, according to age distributions
    to_vaccinate_third_index <- which(vax_assignment$vax_3 == 1)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "18-29 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "18-29 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "30-49 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
  } 
  
  if(realistic_ind == 0){
    print("Optimistic or Pessimistic uptake")
    vax_assignment$vax_3 <- vax_assignment$vax_1
    vax_assignment$third_vaccine_wave <- if_else(vax_assignment$vax_3 == 1, vax_assignment$vaccine_wave + 365, 0)
    
    print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
    print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
    print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
    print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
    print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
    print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
    
    print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy"))* 0.967)))
    print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
    
    print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
    print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
    
    print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
    print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
  }
  
  return(vax_assignment %>% arrange(individual))
}

#Strategy 3: Annual vaccine to 30 years and older
strategy_3 <- function(df, first_dose_data, second_dose_data, next_year_dose_data, realistic_ind){
  
  #Assign who is getting vaccinated using age-specific and risk-specific coverage rates
  # NOTE: `vax_1`, `vax_2`, `vax_3` assigns who will get 1st, 2nd, or 3rd doses based on assumed coverage rates.
  #       `vaccine_wave`, `second_vaccine_wave`, `third_vaccine_wave` assigns when those doses are administered based on assumed uptake
  vax_assignment <- df %>% mutate(vax_1 = 0, vax_2 = 0, vax_3 = 0, vaccine_wave = 0, second_vaccine_wave = 0, third_vaccine_wave = 0)
  
  #Pull coverage rates from first and second dose data
  first_dose_coverage <- (first_dose_data %>% filter(week == 52) %>% arrange(age_group, risk_group))$risk_coverage/100
  
  #For 0-17 years age bin, assume that 96.7% of 0-17 years are older than 6 months (CRUDE ASSUMPTION)
  age_0_17_index <- which(vax_assignment$age_group == "0-17 years")
  age_0_17_index <- sample(age_0_17_index, length(age_0_17_index) * 0.967)
  
  age_18_29_index <- which(vax_assignment$age_group == "18-29 years")
  age_30_49_index <- which(vax_assignment$age_group == "30-49 years")
  age_50_64_index <- which(vax_assignment$age_group == "50-64 years")
  age_65_74_index <- which(vax_assignment$age_group == "65-74 years")
  age_75_plus_index <- which(vax_assignment$age_group == "75+ years")
  
  risk_healthy_index <- which(vax_assignment$risk_group == "healthy")
  risk_highrisk_index <- which(vax_assignment$risk_group == "higher risk")
  risk_immuno_index <- which(vax_assignment$risk_group == "immunocompromised")
  
  prev_vaccinated <- which(vax_assignment$prior_vacc != "unvax")
  
  vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[7] * length(Reduce(intersect, list(age_30_49_index,risk_healthy_index)))/length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated))), 1, if_else(first_dose_coverage[8] * length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated))) > 1, 1, first_dose_coverage[8] * length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated)))))
  vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))), 1, if_else(first_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))) > 1, 1, first_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated)))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[10] * length(Reduce(intersect, list(age_50_64_index,risk_healthy_index)))/length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[11] * length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[12] * length(Reduce(intersect, list(age_50_64_index,risk_immuno_index)))/length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[13] * length(Reduce(intersect, list(age_65_74_index,risk_healthy_index)))/length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[14] * length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[15] * length(Reduce(intersect, list(age_65_74_index,risk_immuno_index)))/length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[16] * length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[17] * length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[18] * length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))))
  
  print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
  print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
  print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
  print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
  print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
  print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
  
  print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy"))* 0.967)))
  print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
  
  print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
  print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
  
  print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
  print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
  
  #Assign who is getting the second vaccine dose 
  # NOTE: Only individuals who have already been assigned with receiving the first vaccine dose `vax_1` are eligible for the second vaccine dose. Since we are sampling only
  #       from individuals who have been assigned first vaccine dose but we are trying to hit the age/risk-specific coverage targets for the entire age/risk group 
  #       (including those who aren't eligible for the second dose), we adjust the coverage upwards for the probability in the rbinom function.
  print(paste0("Percentage of immunocompromised receiving second dose: ",  length(which(vax_assignment$risk_group %in% c("immunocompromised") & vax_assignment$vax_2 == 1))/length(which(vax_assignment$risk_group %in% c("immunocompromised")))))
  print(paste0("Percentage of 65-74 years receiving second dose: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_2 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
  print(paste0("Percentage of 75+ years receiving second dose: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_2 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
  
  #distribute first vaccine dose over first 365 days, according to age-specific distribution of assumed coverage
  to_vaccinate_index <- which(vax_assignment$vax_1 == 1)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  #For assignment of annual dose in year 2 of simulation, uptake assignment code differs depending on if assumed coverage is HISTORIC vs. OPTIMISTIC/PESSIMISTIC.
  # NOTE: If coverage is HISTORIC (`realistic_ind == 1`), then vaccine assignment for annual dose in year 2 is done more carefully since historic coverage is different in year 1 vs. 2.
  #       If coverage is OPTIMISTIC/PESSIMISTIC (`realistic_ind == 0`), then all individuals assigned to receive annual dose in year 1 are re-assigned to receive annual dose in year 2.
  if(realistic_ind == 1) {
    
    second_dose_eligible <- which(vax_assignment$vax_1 == 1)
    
    vax_assignment$vax_3[Reduce(intersect, list(age_30_49_index,risk_healthy_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,second_dose_eligible))), 1, 0.121 * length(Reduce(intersect, list(age_30_49_index,risk_healthy_index)))/length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,second_dose_eligible))))
    vax_assignment$vax_3[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index))) * (0.2428 - 0.2355)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_30_49_index,risk_immuno_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_30_49_index,risk_immuno_index))) * (0.2428 - 0.2355)))] <- 1
    
    
    vax_assignment$vax_3[Reduce(intersect, list(age_50_64_index,risk_healthy_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_50_64_index,risk_healthy_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_50_64_index,risk_healthy_index))) * (0.1471 - 0.1439)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_50_64_index,risk_highrisk_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index))) * (0.2953 - 0.2591)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_50_64_index,risk_immuno_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_50_64_index,risk_immuno_index))) * (0.2953 - 0.2591)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_healthy_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_healthy_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_healthy_index)),second_dose_eligible)) * (0.2334 - 0.2228)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)),second_dose_eligible)) * (0.4685 - 0.3710)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_immuno_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_immuno_index)),second_dose_eligible)) * (0.4685 - 0.3710)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)),second_dose_eligible)) * (0.254 - 0.221)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)),second_dose_eligible)) * (0.5097 - 0.3379)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)),second_dose_eligible)) * (0.5097 - 0.3379)))] <- 1
    
    print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
    print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
    print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
    print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
    print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
    print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
    
    print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy")) * 0.967)))
    print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
    
    print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
    print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
    
    print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
    print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
    
    #distribute vaccine uptake over last 182 days, according to age distributions
    to_vaccinate_third_index <- which(vax_assignment$vax_3 == 1)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "30-49 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
  } 
  
  if(realistic_ind == 0){
    print("Optimistic or Pessimistic uptake")
    vax_assignment$vax_3 <- vax_assignment$vax_1
    vax_assignment$third_vaccine_wave <- if_else(vax_assignment$vax_3 == 1, vax_assignment$vaccine_wave + 365, 0)
    
    print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
    print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
    print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
    print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
    print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
    print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
    
    print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy"))* 0.967)))
    print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
    
    print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
    print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
    
    print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
    print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
  }
  
  return(vax_assignment %>% arrange(individual))
}

#Strategy 4: Annual vaccine to 65+ years and those with immunocompromised conditions (Risk-based vaccination: traditional groups)
strategy_4 <- function(df, first_dose_data, second_dose_data, next_year_dose_data, realistic_ind){
  
  #Assign who is getting vaccinated using age-specific and risk-specific coverage rates
  # NOTE: `vax_1`, `vax_2`, `vax_3` assigns who will get 1st, 2nd, or 3rd doses based on assumed coverage rates.
  #       `vaccine_wave`, `second_vaccine_wave`, `third_vaccine_wave` assigns when those doses are administered based on assumed uptake
  vax_assignment <- df %>% mutate(vax_1 = 0, vax_2 = 0, vax_3 = 0, vaccine_wave = 0, second_vaccine_wave = 0, third_vaccine_wave = 0)
  
  #Pull coverage rates from first and second dose data
  first_dose_coverage <- (first_dose_data %>% filter(week == 52) %>% arrange(age_group, risk_group))$risk_coverage/100
  
  #For 0-17 years age bin, assume that 96.7% of 0-17 years are older than 6 months (CRUDE ASSUMPTION)
  age_0_17_index <- which(vax_assignment$age_group == "0-17 years")
  age_0_17_index <- sample(age_0_17_index, length(age_0_17_index) * 0.967)
  
  age_18_29_index <- which(vax_assignment$age_group == "18-29 years")
  age_30_49_index <- which(vax_assignment$age_group == "30-49 years")
  age_50_64_index <- which(vax_assignment$age_group == "50-64 years")
  age_65_74_index <- which(vax_assignment$age_group == "65-74 years")
  age_75_plus_index <- which(vax_assignment$age_group == "75+ years")
  
  risk_healthy_index <- which(vax_assignment$risk_group == "healthy")
  risk_highrisk_index <- which(vax_assignment$risk_group == "higher risk")
  risk_immuno_index <- which(vax_assignment$risk_group == "immunocompromised")
  
  prev_vaccinated <- which(vax_assignment$prior_vacc != "unvax")
  
  vax_assignment$vax_1[Reduce(intersect, list(age_0_17_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,prev_vaccinated))), 1, if_else(first_dose_coverage[3] * length(Reduce(intersect, list(age_0_17_index,risk_immuno_index)))/length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,prev_vaccinated))) > 1, 1, first_dose_coverage[3] * length(Reduce(intersect, list(age_0_17_index,risk_immuno_index)))/length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,prev_vaccinated)))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated))), 1, if_else(first_dose_coverage[6] * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated))) > 1, 1, first_dose_coverage[6] * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated)))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))), 1, if_else(first_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))) > 1, 1, first_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated)))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[12] * length(Reduce(intersect, list(age_50_64_index,risk_immuno_index)))/length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[13] * length(Reduce(intersect, list(age_65_74_index,risk_healthy_index)))/length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[14] * length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[15] * length(Reduce(intersect, list(age_65_74_index,risk_immuno_index)))/length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[16] * length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[17] * length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[18] * length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))))
  
  print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
  print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
  print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
  print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
  print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
  print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
  
  print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy"))* 0.967)))
  print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
  
  print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
  print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
  
  print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
  print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
  
  #Assign who is getting the second vaccine dose 
  # NOTE: Only individuals who have already been assigned with receiving the first vaccine dose `vax_1` are eligible for the second vaccine dose. Since we are sampling only
  #       from individuals who have been assigned first vaccine dose but we are trying to hit the age/risk-specific coverage targets for the entire age/risk group 
  #       (including those who aren't eligible for the second dose), we adjust the coverage upwards for the probability in the rbinom function.
  print(paste0("Percentage of immunocompromised receiving second dose: ",  length(which(vax_assignment$risk_group %in% c("immunocompromised") & vax_assignment$vax_2 == 1))/length(which(vax_assignment$risk_group %in% c("immunocompromised")))))
  print(paste0("Percentage of 65-74 years receiving second dose: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_2 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
  print(paste0("Percentage of 75+ years receiving second dose: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_2 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
  
  #distribute first vaccine dose over first 365 days, according to age-specific distribution of assumed coverage
  to_vaccinate_index <- which(vax_assignment$vax_1 == 1)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  #For assignment of annual dose in year 2 of simulation, uptake assignment code differs depending on if assumed coverage is HISTORIC vs. OPTIMISTIC/PESSIMISTIC.
  # NOTE: If coverage is HISTORIC (`realistic_ind == 1`), then vaccine assignment for annual dose in year 2 is done more carefully since historic coverage is different in year 1 vs. 2.
  #       If coverage is OPTIMISTIC/PESSIMISTIC (`realistic_ind == 0`), then all individuals assigned to receive annual dose in year 1 are re-assigned to receive annual dose in year 2.
  if(realistic_ind == 1) {
    
    second_dose_eligible <- which(vax_assignment$vax_1 == 1)

    vax_assignment$vax_3[Reduce(intersect, list(age_0_17_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_0_17_index,risk_immuno_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_0_17_index,risk_immuno_index))) * (0.2397 - 0.235)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))), 1, 0.1521 * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))))
    
    vax_assignment$vax_3[Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_30_49_index,risk_immuno_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_30_49_index,risk_immuno_index))) * (0.2428 - 0.2355)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_50_64_index,risk_immuno_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_50_64_index,risk_immuno_index))) * (0.2953 - 0.2591)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_healthy_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_healthy_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_healthy_index)),second_dose_eligible)) * (0.2334 - 0.2228)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)),second_dose_eligible)) * (0.4685 - 0.3710)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_immuno_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_immuno_index)),second_dose_eligible)) * (0.4685 - 0.3710)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)),second_dose_eligible)) * (0.254 - 0.221)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)),second_dose_eligible)) * (0.5097 - 0.3379)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)),second_dose_eligible)) * (0.5097 - 0.3379)))] <- 1
    
    print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
    print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
    print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
    print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
    print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
    print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
    
    print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy")) * 0.967)))
    print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
    
    print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
    print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
    
    print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
    print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
    
    #distribute vaccine uptake over last 182 days, according to age distributions
    to_vaccinate_third_index <- which(vax_assignment$vax_3 == 1)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "0-17 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
  } 
  
  if(realistic_ind == 0){
    print("Optimistic or Pessimistic uptake")
    vax_assignment$vax_3 <- vax_assignment$vax_1
    vax_assignment$third_vaccine_wave <- if_else(vax_assignment$vax_3 == 1, vax_assignment$vaccine_wave + 365, 0)
    
    print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
    print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
    print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
    print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
    print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
    print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
    
    print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy"))* 0.967)))
    print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
    
    print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
    print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
    
    print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
    print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
  }
  
  return(vax_assignment %>% arrange(individual))
}

#Strategy 5: Semiannual vaccine to 65+ years and those with immunocompromised conditions (Risk-based vaccination: traditional groups)
strategy_5 <- function(df, first_dose_data, second_dose_data, next_year_dose_data, realistic_ind){
  
  #Assign who is getting vaccinated using age-specific and risk-specific coverage rates
  # NOTE: `vax_1`, `vax_2`, `vax_3` assigns who will get 1st, 2nd, or 3rd doses based on assumed coverage rates.
  #       `vaccine_wave`, `second_vaccine_wave`, `third_vaccine_wave` assigns when those doses are administered based on assumed uptake
  vax_assignment <- df %>% mutate(vax_1 = 0, vax_2 = 0, vax_3 = 0, vaccine_wave = 0, second_vaccine_wave = 0, third_vaccine_wave = 0)
  
  #Pull coverage rates from first and second dose data
  first_dose_coverage <- (first_dose_data %>% filter(week == 52) %>% arrange(age_group, risk_group))$risk_coverage/100
  second_dose_coverage <- (second_dose_data %>% filter(week == 52) %>% arrange(age_group, risk_group))$coverage/100
  
  #For 0-17 years age bin, assume that 96.7% of 0-17 years are older than 6 months (CRUDE ASSUMPTION)
  age_0_17_index <- which(vax_assignment$age_group == "0-17 years")
  age_0_17_index <- sample(age_0_17_index, length(age_0_17_index) * 0.967)
  
  age_18_29_index <- which(vax_assignment$age_group == "18-29 years")
  age_30_49_index <- which(vax_assignment$age_group == "30-49 years")
  age_50_64_index <- which(vax_assignment$age_group == "50-64 years")
  age_65_74_index <- which(vax_assignment$age_group == "65-74 years")
  age_75_plus_index <- which(vax_assignment$age_group == "75+ years")
  
  risk_healthy_index <- which(vax_assignment$risk_group == "healthy")
  risk_highrisk_index <- which(vax_assignment$risk_group == "higher risk")
  risk_immuno_index <- which(vax_assignment$risk_group == "immunocompromised")
  
  prev_vaccinated <- which(vax_assignment$prior_vacc != "unvax")
  
  vax_assignment$vax_1[Reduce(intersect, list(age_0_17_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,prev_vaccinated))), 1, if_else(first_dose_coverage[3] * length(Reduce(intersect, list(age_0_17_index,risk_immuno_index)))/length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,prev_vaccinated))) > 1, 1, first_dose_coverage[3] * length(Reduce(intersect, list(age_0_17_index,risk_immuno_index)))/length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,prev_vaccinated)))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated))), 1, if_else(first_dose_coverage[6] * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated))) > 1, 1, first_dose_coverage[6] * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated)))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))), 1, if_else(first_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))) > 1, 1, first_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated)))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[12] * length(Reduce(intersect, list(age_50_64_index,risk_immuno_index)))/length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[13] * length(Reduce(intersect, list(age_65_74_index,risk_healthy_index)))/length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[14] * length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[15] * length(Reduce(intersect, list(age_65_74_index,risk_immuno_index)))/length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[16] * length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[17] * length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[18] * length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))))
  
  print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
  print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
  print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
  print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
  print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
  print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
  
  print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy"))* 0.967)))
  print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
  
  print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
  print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
  
  print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
  print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
  
  #Assign who is getting the second vaccine dose 
  # NOTE: Only individuals who have already been assigned with receiving the first vaccine dose `vax_1` are eligible for the second vaccine dose. Since we are sampling only
  #       from individuals who have been assigned first vaccine dose but we are trying to hit the age/risk-specific coverage targets for the entire age/risk group 
  #       (including those who aren't eligible for the second dose), we adjust the coverage upwards for the probability in the rbinom function.
  second_dose_eligible <- which(vax_assignment$vax_1 == 1)
  
  vax_assignment$vax_2[Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))), 1, if_else(second_dose_coverage[6] * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))) > 1, 1, second_dose_coverage[6] * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible)))))
  vax_assignment$vax_2[Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))), 1, if_else(second_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))) > 1, 1, second_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible)))))
  vax_assignment$vax_2[Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))), 1, if_else(second_dose_coverage[12] * length(Reduce(intersect, list(age_50_64_index,risk_immuno_index)))/length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))) > 1, 1, second_dose_coverage[12] * length(Reduce(intersect, list(age_50_64_index,risk_immuno_index)))/length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible)))))
  
  vax_assignment$vax_2[Reduce(intersect, list(age_65_74_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,second_dose_eligible))), 1, if_else(second_dose_coverage[13] * length(Reduce(intersect, list(age_65_74_index)))/length(Reduce(intersect, list(age_65_74_index,second_dose_eligible))) > 1, 1, second_dose_coverage[13] * length(Reduce(intersect, list(age_65_74_index)))/length(Reduce(intersect, list(age_65_74_index,second_dose_eligible)))))
  vax_assignment$vax_2[Reduce(intersect, list(age_75_plus_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,second_dose_eligible))), 1, if_else(second_dose_coverage[16] * length(Reduce(intersect, list(age_75_plus_index)))/length(Reduce(intersect, list(age_75_plus_index,second_dose_eligible))) > 1, 1, second_dose_coverage[16] * length(Reduce(intersect, list(age_75_plus_index)))/length(Reduce(intersect, list(age_75_plus_index,second_dose_eligible)))))
  
  print(paste0("Percentage of immunocompromised receiving second dose: ",  length(which(vax_assignment$risk_group %in% c("immunocompromised") & vax_assignment$vax_2 == 1))/length(which(vax_assignment$risk_group %in% c("immunocompromised")))))
  print(paste0("Percentage of 65-74 years receiving second dose: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_2 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
  print(paste0("Percentage of 75+ years receiving second dose: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_2 == 1))/length(which(vax_assignment$age_group == "75+ years"))))

  #distribute first vaccine dose over first 365 days, according to age-specific distribution of assumed coverage
  to_vaccinate_index <- which(vax_assignment$vax_1 == 1)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  #distribute second dose booster uptake over next 365 days, according to age distributions
  to_vaccinate_second_index <- which(vax_assignment$vax_2 == 1)
  
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  #For assignment of annual dose in year 2 of simulation, uptake assignment code differs depending on if assumed coverage is HISTORIC vs. OPTIMISTIC/PESSIMISTIC.
  # NOTE: If coverage is HISTORIC (`realistic_ind == 1`), then vaccine assignment for annual dose in year 2 is done more carefully since historic coverage is different in year 1 vs. 2.
  #       If coverage is OPTIMISTIC/PESSIMISTIC (`realistic_ind == 0`), then all individuals assigned to receive annual dose in year 1 are re-assigned to receive annual dose in year 2.
  if(realistic_ind == 1) {
    
    third_dose_eligible <- which(vax_assignment$vax_2 == 1)
    vax_assignment$vax_3[Reduce(intersect, list(age_0_17_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_0_17_index,risk_immuno_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_0_17_index,risk_immuno_index))) * (0.2397 - 0.235)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_18_29_index,risk_immuno_index,third_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible)), third_dose_eligible), round(length(Reduce(intersect, list(age_18_29_index,risk_immuno_index))) * (0.1521 - 0.054)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_30_49_index,risk_immuno_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_30_49_index,risk_immuno_index))) * (0.2428 - 0.2355)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_50_64_index,risk_immuno_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_50_64_index,risk_immuno_index))) * (0.2953 - 0.2591)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_healthy_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_healthy_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_healthy_index)),second_dose_eligible)) * (0.2334 - 0.2228)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)),second_dose_eligible)) * (0.4685 - 0.3710)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_immuno_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_immuno_index)),second_dose_eligible)) * (0.4685 - 0.3710)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)),second_dose_eligible)) * (0.254 - 0.221)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)),second_dose_eligible)) * (0.5097 - 0.3379)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)),second_dose_eligible)) * (0.5097 - 0.3379)))] <- 1
    
    print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
    print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
    print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
    print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
    print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
    print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
    
    print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy")) * 0.967)))
    print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
    
    print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
    print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
    
    print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
    print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
    
    #distribute vaccine uptake over last 182 days, according to age distributions
    to_vaccinate_third_index <- which(vax_assignment$vax_3 == 1)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "0-17 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
  } 
  
  if(realistic_ind == 0){
    print("Optimistic or Pessimistic uptake")
    vax_assignment$vax_3 <- vax_assignment$vax_1
    vax_assignment$third_vaccine_wave <- if_else(vax_assignment$vax_3 == 1, vax_assignment$vaccine_wave + 365, 0)
    
    print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
    print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
    print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
    print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
    print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
    print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
    
    print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy"))* 0.967)))
    print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
    
    print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
    print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
    
    print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
    print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
  }
  
  return(vax_assignment %>% arrange(individual))
}

#Strategy 6: Strategy 4, including 18-64 years with significant co-morbidities (‘higher risk’) - (Risk-based vaccination: expanded groups)
strategy_6 <- function(df, first_dose_data, second_dose_data, next_year_dose_data, realistic_ind){
  
  #Assign who is getting vaccinated using age-specific and risk-specific coverage rates
  # NOTE: `vax_1`, `vax_2`, `vax_3` assigns who will get 1st, 2nd, or 3rd doses based on assumed coverage rates.
  #       `vaccine_wave`, `second_vaccine_wave`, `third_vaccine_wave` assigns when those doses are administered based on assumed uptake
  vax_assignment <- df %>% mutate(vax_1 = 0, vax_2 = 0, vax_3 = 0, vaccine_wave = 0, second_vaccine_wave = 0, third_vaccine_wave = 0)
  
  #Pull coverage rates from first and second dose data
  first_dose_coverage <- (first_dose_data %>% filter(week == 52) %>% arrange(age_group, risk_group))$risk_coverage/100
  
  #For 0-17 years age bin, assume that 96.7% of 0-17 years are older than 6 months (CRUDE ASSUMPTION)
  age_0_17_index <- which(vax_assignment$age_group == "0-17 years")
  age_0_17_index <- sample(age_0_17_index, length(age_0_17_index) * 0.967)
  
  age_18_29_index <- which(vax_assignment$age_group == "18-29 years")
  age_30_49_index <- which(vax_assignment$age_group == "30-49 years")
  age_50_64_index <- which(vax_assignment$age_group == "50-64 years")
  age_65_74_index <- which(vax_assignment$age_group == "65-74 years")
  age_75_plus_index <- which(vax_assignment$age_group == "75+ years")
  
  risk_healthy_index <- which(vax_assignment$risk_group == "healthy")
  risk_highrisk_index <- which(vax_assignment$risk_group == "higher risk")
  risk_immuno_index <- which(vax_assignment$risk_group == "immunocompromised")
  
  prev_vaccinated <- which(vax_assignment$prior_vacc != "unvax")
  
  vax_assignment$vax_1[Reduce(intersect, list(age_0_17_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index,prev_vaccinated))), 1, if_else(first_dose_coverage[2] * length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index,prev_vaccinated))) > 1, 1, first_dose_coverage[2] * length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index,prev_vaccinated)))))
  vax_assignment$vax_1[Reduce(intersect, list(age_0_17_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,prev_vaccinated))), 1, if_else(first_dose_coverage[3] * length(Reduce(intersect, list(age_0_17_index,risk_immuno_index)))/length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,prev_vaccinated))) > 1, 1, first_dose_coverage[3] * length(Reduce(intersect, list(age_0_17_index,risk_immuno_index)))/length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,prev_vaccinated)))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,prev_vaccinated))), 1, if_else(first_dose_coverage[5] * length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,prev_vaccinated))) > 1, 1, first_dose_coverage[5] * length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,prev_vaccinated)))))
  vax_assignment$vax_1[Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated))), 1, if_else(first_dose_coverage[6] * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated))) > 1, 1, first_dose_coverage[6] * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated)))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated))), 1, if_else(first_dose_coverage[8] * length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated))) > 1, 1, first_dose_coverage[8] * length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated)))))
  vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))), 1, if_else(first_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))) > 1, 1, first_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated)))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[11] * length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[12] * length(Reduce(intersect, list(age_50_64_index,risk_immuno_index)))/length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[13] * length(Reduce(intersect, list(age_65_74_index,risk_healthy_index)))/length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[14] * length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[15] * length(Reduce(intersect, list(age_65_74_index,risk_immuno_index)))/length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[16] * length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[17] * length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[18] * length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))))
  
  print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
  print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
  print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
  print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
  print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
  print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
  
  print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy"))* 0.967)))
  print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
  
  print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
  print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
  
  print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
  print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
  
  #Assign who is getting the second dose of the updated booster (filter among individuals who have already been assigned with receiving 1 updated booster) 
  print(paste0("Percentage of higher risk and immunocompromised receiving second dose: ",  length(which(vax_assignment$risk_group %in% c("higher risk", "immunocompromised") & vax_assignment$vax_2 == 1))/length(which(vax_assignment$risk_group %in% c("higher risk", "immunocompromised")))))
  print(paste0("Percentage of 65-74 years receiving second dose: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_2 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
  print(paste0("Percentage of 75+ years receiving second dose: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_2 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
  
  
  #distribute first vaccine dose over first 365 days, according to age-specific distribution of assumed coverage
  to_vaccinate_index <- which(vax_assignment$vax_1 == 1)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  #For assignment of annual dose in year 2 of simulation, uptake assignment code differs depending on if assumed coverage is HISTORIC vs. OPTIMISTIC/PESSIMISTIC.
  # NOTE: If coverage is HISTORIC (`realistic_ind == 1`), then vaccine assignment for annual dose in year 2 is done more carefully since historic coverage is different in year 1 vs. 2.
  #       If coverage is OPTIMISTIC/PESSIMISTIC (`realistic_ind == 0`), then all individuals assigned to receive annual dose in year 1 are re-assigned to receive annual dose in year 2.
  if(realistic_ind == 1) {
    
   second_dose_eligible <- which(vax_assignment$vax_1 == 1)
    
    vax_assignment$vax_3[Reduce(intersect, list(age_0_17_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_0_17_index,risk_highrisk_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index))) * (0.2397 - 0.235)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_0_17_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_0_17_index,risk_immuno_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_0_17_index,risk_immuno_index))) * (0.2397 - 0.235)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,second_dose_eligible))), 1, 0.1521 * length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,second_dose_eligible))))
    vax_assignment$vax_3[Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))), 1, 0.1521 * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))))
    
    vax_assignment$vax_3[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index))) * (0.2428 - 0.2355)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_30_49_index,risk_immuno_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_30_49_index,risk_immuno_index))) * (0.2428 - 0.2355)))] <- 1
    
    
    vax_assignment$vax_3[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_50_64_index,risk_highrisk_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index))) * (0.2953 - 0.2591)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_50_64_index,risk_immuno_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_50_64_index,risk_immuno_index))) * (0.2953 - 0.2591)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_healthy_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_healthy_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_healthy_index)),second_dose_eligible)) * (0.2334 - 0.2228)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)),second_dose_eligible)) * (0.4685 - 0.3710)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_immuno_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_immuno_index)),second_dose_eligible)) * (0.4685 - 0.3710)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)),second_dose_eligible)) * (0.254 - 0.221)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)),second_dose_eligible)) * (0.5097 - 0.3379)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)),second_dose_eligible)) * (0.5097 - 0.3379)))] <- 1
    
    print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
    print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
    print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
    print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
    print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
    print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
    
    print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy")) * 0.967)))
    print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
    
    print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
    print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
    
    print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
    print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
    
    #distribute vaccine uptake over last 182 days, according to age distributions
    to_vaccinate_third_index <- which(vax_assignment$vax_3 == 1)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "0-17 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "0-17 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "18-29 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
  } 
  
  if(realistic_ind == 0){
    print("Optimistic or Pessimistic uptake")
    vax_assignment$vax_3 <- vax_assignment$vax_1
    vax_assignment$third_vaccine_wave <- if_else(vax_assignment$vax_3 == 1, vax_assignment$vaccine_wave + 365, 0)
    
    print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
    print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
    print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
    print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
    print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
    print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
    
    print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy"))* 0.967)))
    print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
    
    print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
    print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
    
    print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
    print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
  }
  
  return(vax_assignment %>% arrange(individual))
}

#Strategy 7: Strategy 5, including 18-64 years with significant co-morbidities (‘higher risk’) - (Risk-based vaccination: expanded groups)
strategy_7 <- function(df, first_dose_data, second_dose_data, next_year_dose_data, realistic_ind){
  
  #Assign who is getting vaccinated using age-specific and risk-specific coverage rates
  # NOTE: `vax_1`, `vax_2`, `vax_3` assigns who will get 1st, 2nd, or 3rd doses based on assumed coverage rates.
  #       `vaccine_wave`, `second_vaccine_wave`, `third_vaccine_wave` assigns when those doses are administered based on assumed uptake
  vax_assignment <- df %>% mutate(vax_1 = 0, vax_2 = 0, vax_3 = 0, vaccine_wave = 0, second_vaccine_wave = 0, third_vaccine_wave = 0)
  
  #Pull coverage rates from first and second dose data
  first_dose_coverage <- (first_dose_data %>% filter(week == 52) %>% arrange(age_group, risk_group))$risk_coverage/100
  second_dose_coverage <- (second_dose_data %>% filter(week == 52) %>% arrange(age_group, risk_group))$coverage/100
  
  #For 0-17 years age bin, assume that 96.7% of 0-17 years are older than 6 months (CRUDE ASSUMPTION)
  age_0_17_index <- which(vax_assignment$age_group == "0-17 years")
  age_0_17_index <- sample(age_0_17_index, length(age_0_17_index) * 0.967)
  
  age_18_29_index <- which(vax_assignment$age_group == "18-29 years")
  age_30_49_index <- which(vax_assignment$age_group == "30-49 years")
  age_50_64_index <- which(vax_assignment$age_group == "50-64 years")
  age_65_74_index <- which(vax_assignment$age_group == "65-74 years")
  age_75_plus_index <- which(vax_assignment$age_group == "75+ years")
  
  risk_healthy_index <- which(vax_assignment$risk_group == "healthy")
  risk_highrisk_index <- which(vax_assignment$risk_group == "higher risk")
  risk_immuno_index <- which(vax_assignment$risk_group == "immunocompromised")
  
  prev_vaccinated <- which(vax_assignment$prior_vacc != "unvax")
  
  vax_assignment$vax_1[Reduce(intersect, list(age_0_17_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index,prev_vaccinated))), 1, if_else(first_dose_coverage[2] * length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index,prev_vaccinated))) > 1, 1, first_dose_coverage[2] * length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index,prev_vaccinated)))))
  vax_assignment$vax_1[Reduce(intersect, list(age_0_17_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,prev_vaccinated))), 1, if_else(first_dose_coverage[3] * length(Reduce(intersect, list(age_0_17_index,risk_immuno_index)))/length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,prev_vaccinated))) > 1, 1, first_dose_coverage[3] * length(Reduce(intersect, list(age_0_17_index,risk_immuno_index)))/length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,prev_vaccinated)))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,prev_vaccinated))), 1, if_else(first_dose_coverage[5] * length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,prev_vaccinated))) > 1, 1, first_dose_coverage[5] * length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,prev_vaccinated)))))
  vax_assignment$vax_1[Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated))), 1, if_else(first_dose_coverage[6] * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated))) > 1, 1, first_dose_coverage[6] * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated)))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated))), 1, if_else(first_dose_coverage[8] * length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated))) > 1, 1, first_dose_coverage[8] * length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated)))))
  vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))), 1, if_else(first_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))) > 1, 1, first_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated)))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[11] * length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[12] * length(Reduce(intersect, list(age_50_64_index,risk_immuno_index)))/length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[13] * length(Reduce(intersect, list(age_65_74_index,risk_healthy_index)))/length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[14] * length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[15] * length(Reduce(intersect, list(age_65_74_index,risk_immuno_index)))/length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[16] * length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[17] * length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[18] * length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))))
  
  print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
  print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
  print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
  print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
  print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
  print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
  
  print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy"))* 0.967)))
  print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
  
  print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
  print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
  
  print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
  print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
  
  #Assign who is getting the second vaccine dose 
  # NOTE: Only individuals who have already been assigned with receiving the first vaccine dose `vax_1` are eligible for the second vaccine dose. Since we are sampling only
  #       from individuals who have been assigned first vaccine dose but we are trying to hit the age/risk-specific coverage targets for the entire age/risk group 
  #       (including those who aren't eligible for the second dose), we adjust the coverage upwards for the probability in the rbinom function.
  second_dose_eligible <- which(vax_assignment$vax_1 == 1)
  
  vax_assignment$vax_2[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,second_dose_eligible))), 1, if_else(second_dose_coverage[5] * length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,second_dose_eligible))) > 1, 1, second_dose_coverage[5] * length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,second_dose_eligible)))))
  vax_assignment$vax_2[Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))), 1, if_else(second_dose_coverage[6] * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))) > 1, 1, second_dose_coverage[6] * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible)))))
  
  vax_assignment$vax_2[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,second_dose_eligible))), 1, if_else(second_dose_coverage[8] * length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,second_dose_eligible))) > 1, 1, second_dose_coverage[8] * length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,second_dose_eligible)))))
  vax_assignment$vax_2[Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))), 1, if_else(second_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))) > 1, 1, second_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible)))))
  
  vax_assignment$vax_2[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,second_dose_eligible))), 1, if_else(second_dose_coverage[11] * length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,second_dose_eligible))) > 1, 1, second_dose_coverage[11] * length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,second_dose_eligible)))))
  vax_assignment$vax_2[Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))), 1, if_else(second_dose_coverage[12] * length(Reduce(intersect, list(age_50_64_index,risk_immuno_index)))/length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))) > 1, 1, second_dose_coverage[12] * length(Reduce(intersect, list(age_50_64_index,risk_immuno_index)))/length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible)))))

  vax_assignment$vax_2[Reduce(intersect, list(age_65_74_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,second_dose_eligible))), 1, if_else(second_dose_coverage[13] * length(Reduce(intersect, list(age_65_74_index)))/length(Reduce(intersect, list(age_65_74_index,second_dose_eligible))) > 1, 1, second_dose_coverage[13] * length(Reduce(intersect, list(age_65_74_index)))/length(Reduce(intersect, list(age_65_74_index,second_dose_eligible)))))
  vax_assignment$vax_2[Reduce(intersect, list(age_75_plus_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,second_dose_eligible))), 1, if_else(second_dose_coverage[16] * length(Reduce(intersect, list(age_75_plus_index)))/length(Reduce(intersect, list(age_75_plus_index,second_dose_eligible))) > 1, 1, second_dose_coverage[16] * length(Reduce(intersect, list(age_75_plus_index)))/length(Reduce(intersect, list(age_75_plus_index,second_dose_eligible)))))
  
  print(paste0("Percentage of higher risk and immunocompromised receiving second dose: ",  length(which(vax_assignment$risk_group %in% c("higher risk", "immunocompromised") & vax_assignment$vax_2 == 1))/length(which(vax_assignment$risk_group %in% c("higher risk", "immunocompromised")))))
  print(paste0("Percentage of 65-74 years receiving second dose: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_2 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
  print(paste0("Percentage of 75+ years receiving second dose: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_2 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
  
  #distribute first vaccine dose over first 365 days, according to age-specific distribution of assumed coverage
  to_vaccinate_index <- which(vax_assignment$vax_1 == 1)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  #distribute second dose booster uptake over next 365 days, according to age distributions
  to_vaccinate_second_index <- which(vax_assignment$vax_2 == 1)
  
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "18-29 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  #For assignment of annual dose in year 2 of simulation, uptake assignment code differs depending on if assumed coverage is HISTORIC vs. OPTIMISTIC/PESSIMISTIC.
  # NOTE: If coverage is HISTORIC (`realistic_ind == 1`), then vaccine assignment for annual dose in year 2 is done more carefully since historic coverage is different in year 1 vs. 2.
  #       If coverage is OPTIMISTIC/PESSIMISTIC (`realistic_ind == 0`), then all individuals assigned to receive annual dose in year 1 are re-assigned to receive annual dose in year 2.
  if(realistic_ind == 1) {
    
    third_dose_eligible <- which(vax_assignment$vax_2 == 1)
    
    #Assign who will receive the updated booster (validation period)
    vax_assignment$vax_3[Reduce(intersect, list(age_0_17_index,risk_highrisk_index,second_dose_eligible))] <- vax_assignment$vax_1[Reduce(intersect, list(age_0_17_index,risk_highrisk_index,second_dose_eligible))]
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_0_17_index,risk_highrisk_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_0_17_index,risk_highrisk_index)),second_dose_eligible)) * (0.2397 - 0.235)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_0_17_index,risk_immuno_index,second_dose_eligible))] <- vax_assignment$vax_1[Reduce(intersect, list(age_0_17_index,risk_immuno_index,second_dose_eligible))]
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_0_17_index,risk_immuno_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_0_17_index,risk_immuno_index)),second_dose_eligible)) * (0.2397 - 0.235)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,third_dose_eligible))] <- vax_assignment$vax_1[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,third_dose_eligible))]
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,second_dose_eligible)), third_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,second_dose_eligible)), third_dose_eligible)) * (0.1521 * 3)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_18_29_index,risk_immuno_index,third_dose_eligible))] <- vax_assignment$vax_1[Reduce(intersect, list(age_18_29_index,risk_immuno_index,third_dose_eligible))]
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible)), third_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible)), third_dose_eligible)) * (0.1521 * 3.5)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,second_dose_eligible))] <- vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,second_dose_eligible))]
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)),second_dose_eligible)) * (0.2428 - 0.2355)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))] <- vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))]
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_30_49_index,risk_immuno_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_30_49_index,risk_immuno_index)),second_dose_eligible)) * (0.2428 - 0.2355)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,second_dose_eligible))] <- vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,second_dose_eligible))]
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_50_64_index,risk_highrisk_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_50_64_index,risk_highrisk_index)),second_dose_eligible)) * (0.2953 - 0.2591)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))] <- vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))]
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_50_64_index,risk_immuno_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_50_64_index,risk_immuno_index)),second_dose_eligible)) * (0.2953 - 0.2591)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_healthy_index,second_dose_eligible))] <- vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_healthy_index,second_dose_eligible))]
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_healthy_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_healthy_index)),second_dose_eligible)) * (0.2334 - 0.2228)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,second_dose_eligible))] <- vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,second_dose_eligible))]
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)),second_dose_eligible)) * (0.4685 - 0.3710)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_immuno_index,second_dose_eligible))] <- vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_immuno_index,second_dose_eligible))]
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_immuno_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_immuno_index)),second_dose_eligible)) * (0.4685 - 0.3710)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,second_dose_eligible))] <- vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,second_dose_eligible))]
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)),second_dose_eligible)) * (0.254 - 0.221)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,second_dose_eligible))] <- vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,second_dose_eligible))]
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)),second_dose_eligible)) * (0.5097 - 0.3379)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,second_dose_eligible))] <- vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,second_dose_eligible))]
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)),second_dose_eligible)) * (0.5097 - 0.3379)))] <- 1
    
    print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
    print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
    print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
    print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
    print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
    print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
    
    print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy")) * 0.967)))
    print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
    
    print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
    print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
    
    print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
    print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
    
    #distribute vaccine uptake over last 182 days, according to age distributions
    to_vaccinate_third_index <- which(vax_assignment$vax_3 == 1)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "0-17 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "0-17 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "18-29 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
  } 
  
  if(realistic_ind == 0){
    print("Optimistic or Pessimistic uptake")
    vax_assignment$vax_3 <- vax_assignment$vax_1
    vax_assignment$third_vaccine_wave <- if_else(vax_assignment$vax_3 == 1, vax_assignment$vaccine_wave + 365, 0)
    
    print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
    print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
    print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
    print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
    print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
    print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
    
    print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy"))* 0.967)))
    print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
    
    print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
    print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
    
    print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
    print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
  }
  
  return(vax_assignment %>% arrange(individual))
}

#Strategy 8: Universal (Strategy 1) with second dose in key risk group (Strategy 5) - (Hybrid)
strategy_8 <- function(df, first_dose_data, second_dose_data, next_year_dose_data, realistic_ind){
  
  #Assign who is getting vaccinated using age-specific and risk-specific coverage rates
  # NOTE: `vax_1`, `vax_2`, `vax_3` assigns who will get 1st, 2nd, or 3rd doses based on assumed coverage rates.
  #       `vaccine_wave`, `second_vaccine_wave`, `third_vaccine_wave` assigns when those doses are administered based on assumed uptake
  vax_assignment <- df %>% mutate(vax_1 = 0, vax_2 = 0, vax_3 = 0, vaccine_wave = 0, second_vaccine_wave = 0, third_vaccine_wave = 0)
  
  #Pull coverage rates from first and second dose data
  first_dose_coverage <- (first_dose_data %>% filter(week == 52) %>% arrange(age_group, risk_group))$risk_coverage/100
  second_dose_coverage <- (second_dose_data %>% filter(week == 52) %>% arrange(age_group, risk_group))$coverage/100
  
  #For 0-17 years age bin, assume that 96.7% of 0-17 years are older than 6 months (CRUDE ASSUMPTION)
  age_0_17_index <- which(vax_assignment$age_group == "0-17 years")
  age_0_17_index <- sample(age_0_17_index, length(age_0_17_index) * 0.967)
  
  age_18_29_index <- which(vax_assignment$age_group == "18-29 years")
  age_30_49_index <- which(vax_assignment$age_group == "30-49 years")
  age_50_64_index <- which(vax_assignment$age_group == "50-64 years")
  age_65_74_index <- which(vax_assignment$age_group == "65-74 years")
  age_75_plus_index <- which(vax_assignment$age_group == "75+ years")
  
  risk_healthy_index <- which(vax_assignment$risk_group == "healthy")
  risk_highrisk_index <- which(vax_assignment$risk_group == "higher risk")
  risk_immuno_index <- which(vax_assignment$risk_group == "immunocompromised")
  
  prev_vaccinated <- which(vax_assignment$prior_vacc != "unvax")
  
  vax_assignment$vax_1[Reduce(intersect, list(age_0_17_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_0_17_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[1] * length(Reduce(intersect, list(age_0_17_index,risk_healthy_index)))/length(Reduce(intersect, list(age_0_17_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_0_17_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index,prev_vaccinated))), 1, if_else(first_dose_coverage[2] * length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index,prev_vaccinated))) > 1, 1, first_dose_coverage[2] * length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index,prev_vaccinated)))))
  vax_assignment$vax_1[Reduce(intersect, list(age_0_17_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,prev_vaccinated))), 1, if_else(first_dose_coverage[3] * length(Reduce(intersect, list(age_0_17_index,risk_immuno_index)))/length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,prev_vaccinated))) > 1, 1, first_dose_coverage[3] * length(Reduce(intersect, list(age_0_17_index,risk_immuno_index)))/length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,prev_vaccinated)))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_18_29_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[4] * length(Reduce(intersect, list(age_18_29_index,risk_healthy_index)))/length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,prev_vaccinated))), 1, if_else(first_dose_coverage[5] * length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,prev_vaccinated))) > 1, 1, first_dose_coverage[5] * length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,prev_vaccinated)))))
  vax_assignment$vax_1[Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated))), 1, if_else(first_dose_coverage[6] * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated))) > 1, 1, first_dose_coverage[6] * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated)))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[7] * length(Reduce(intersect, list(age_30_49_index,risk_healthy_index)))/length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated))), 1, if_else(first_dose_coverage[8] * length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated))) > 1, 1, first_dose_coverage[8] * length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated)))))
  vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))), 1, if_else(first_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))) > 1, 1, first_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated)))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[10] * length(Reduce(intersect, list(age_50_64_index,risk_healthy_index)))/length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[11] * length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[12] * length(Reduce(intersect, list(age_50_64_index,risk_immuno_index)))/length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[13] * length(Reduce(intersect, list(age_65_74_index,risk_healthy_index)))/length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[14] * length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[15] * length(Reduce(intersect, list(age_65_74_index,risk_immuno_index)))/length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[16] * length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[17] * length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[18] * length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))))
  
  print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
  print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
  print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
  print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
  print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
  print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
  
  print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy"))* 0.967)))
  print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
  
  print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
  print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
  
  print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
  print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
  
  #Assign who is getting the second vaccine dose 
  # NOTE: Only individuals who have already been assigned with receiving the first vaccine dose `vax_1` are eligible for the second vaccine dose. Since we are sampling only
  #       from individuals who have been assigned first vaccine dose but we are trying to hit the age/risk-specific coverage targets for the entire age/risk group 
  #       (including those who aren't eligible for the second dose), we adjust the coverage upwards for the probability in the rbinom function.
  second_dose_eligible <- which(vax_assignment$vax_1 == 1)
  
  vax_assignment$vax_2[Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))), 1, if_else(second_dose_coverage[6] * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))) > 1, 1, second_dose_coverage[6] * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible)))))
  
  vax_assignment$vax_2[Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))), 1, if_else(second_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))) > 1, 1, second_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible)))))
  
  vax_assignment$vax_2[Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))), 1, if_else(second_dose_coverage[12] * length(Reduce(intersect, list(age_50_64_index,risk_immuno_index)))/length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))) > 1, 1, second_dose_coverage[12] * length(Reduce(intersect, list(age_50_64_index,risk_immuno_index)))/length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible)))))
  
  vax_assignment$vax_2[Reduce(intersect, list(age_65_74_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,second_dose_eligible))), 1, if_else(second_dose_coverage[13] * length(Reduce(intersect, list(age_65_74_index)))/length(Reduce(intersect, list(age_65_74_index,second_dose_eligible))) > 1, 1, second_dose_coverage[13] * length(Reduce(intersect, list(age_65_74_index)))/length(Reduce(intersect, list(age_65_74_index,second_dose_eligible)))))
  vax_assignment$vax_2[Reduce(intersect, list(age_75_plus_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,second_dose_eligible))), 1, if_else(second_dose_coverage[16] * length(Reduce(intersect, list(age_75_plus_index)))/length(Reduce(intersect, list(age_75_plus_index,second_dose_eligible))) > 1, 1, second_dose_coverage[16] * length(Reduce(intersect, list(age_75_plus_index)))/length(Reduce(intersect, list(age_75_plus_index,second_dose_eligible)))))
  
  print(paste0("Percentage of immunocompromised receiving second dose: ",  length(which(vax_assignment$risk_group %in% c("immunocompromised") & vax_assignment$vax_2 == 1))/length(which(vax_assignment$risk_group %in% c("immunocompromised")))))
  print(paste0("Percentage of 65-74 years receiving second dose: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_2 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
  print(paste0("Percentage of 75+ years receiving second dose: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_2 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
  
  #distribute first vaccine dose over first 365 days, according to age-specific distribution of assumed coverage
  to_vaccinate_index <- which(vax_assignment$vax_1 == 1)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_0_17_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "0-17 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  #distribute second dose booster uptake over next 365 days, according to age distributions
  to_vaccinate_second_index <- which(vax_assignment$vax_2 == 1)
  
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  
  #For assignment of annual dose in year 2 of simulation, uptake assignment code differs depending on if assumed coverage is HISTORIC vs. OPTIMISTIC/PESSIMISTIC.
  # NOTE: If coverage is HISTORIC (`realistic_ind == 1`), then vaccine assignment for annual dose in year 2 is done more carefully since historic coverage is different in year 1 vs. 2.
  #       If coverage is OPTIMISTIC/PESSIMISTIC (`realistic_ind == 0`), then all individuals assigned to receive annual dose in year 1 are re-assigned to receive annual dose in year 2.
  if(realistic_ind == 1) {

    #Assign who will receive the updated booster (validation period)
    third_dose_eligible <- which(vax_assignment$vax_2 == 1)
    vax_assignment$vax_3[Reduce(intersect, list(age_0_17_index,risk_healthy_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_0_17_index,risk_healthy_index,second_dose_eligible))), 1, 0.1194 * length(Reduce(intersect, list(age_0_17_index,risk_healthy_index)))/length(Reduce(intersect, list(age_0_17_index,risk_healthy_index,second_dose_eligible))))
    vax_assignment$vax_3[Reduce(intersect, list(age_0_17_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_0_17_index,risk_highrisk_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index))) * (0.2397 - 0.235)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_0_17_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_0_17_index,risk_immuno_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_0_17_index,risk_immuno_index))) * (0.2397 - 0.235)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_18_29_index,risk_healthy_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,second_dose_eligible))), 1, 0.0758 * length(Reduce(intersect, list(age_18_29_index,risk_healthy_index)))/length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,second_dose_eligible))))
    vax_assignment$vax_3[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,third_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,second_dose_eligible)), third_dose_eligible), round(length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index)))  * (0.1521 + 0.05 - 0.054)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_18_29_index,risk_immuno_index,third_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible)), third_dose_eligible), round(length(Reduce(intersect, list(age_18_29_index,risk_immuno_index))) * (0.1521 - 0.054)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_30_49_index,risk_healthy_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,second_dose_eligible))), 1, 0.121 * length(Reduce(intersect, list(age_30_49_index,risk_healthy_index)))/length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,second_dose_eligible))))
    vax_assignment$vax_3[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index))) * (0.2428 - 0.2355)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_30_49_index,risk_immuno_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_30_49_index,risk_immuno_index))) * (0.2428 - 0.2355)))] <- 1
    
    
    vax_assignment$vax_3[Reduce(intersect, list(age_50_64_index,risk_healthy_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_50_64_index,risk_healthy_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_50_64_index,risk_healthy_index))) * (0.1471 - 0.1439)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_50_64_index,risk_highrisk_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index))) * (0.2953 - 0.2591)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_50_64_index,risk_immuno_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_50_64_index,risk_immuno_index))) * (0.2953 - 0.2591)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_healthy_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_healthy_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_healthy_index)),second_dose_eligible)) * (0.2334 - 0.2228)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)),second_dose_eligible)) * (0.4685 - 0.3710)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_immuno_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_immuno_index)),second_dose_eligible)) * (0.4685 - 0.3710)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)),second_dose_eligible)) * (0.254 - 0.221)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)),second_dose_eligible)) * (0.5097 - 0.3379)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)),second_dose_eligible)) * (0.5097 - 0.3379)))] <- 1
    
    print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
    print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
    print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
    print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
    print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
    print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
    
    print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy")) * 0.967)))
    print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
    
    print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
    print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
    
    print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
    print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
    
    #distribute vaccine uptake over last 182 days, according to age distributions
    to_vaccinate_third_index <- which(vax_assignment$vax_3 == 1)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_0_17_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "0-17 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_0_17_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "0-17 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_0_17_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "0-17 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "18-29 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "18-29 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "30-49 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
  } 
  
  if(realistic_ind == 0){
    print("Optimistic or Pessimistic uptake")
    vax_assignment$vax_3 <- vax_assignment$vax_1
    vax_assignment$third_vaccine_wave <- if_else(vax_assignment$vax_3 == 1, vax_assignment$vaccine_wave + 365, 0)
    
    print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
    print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
    print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
    print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
    print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
    print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
    
    print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy"))* 0.967)))
    print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
    
    print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
    print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
    
    print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
    print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
  }
  
  return(vax_assignment %>% arrange(individual))
}

#Strategy 9: Universal (Strategy 2) with second dose in key risk group (Strategy 5) - (Hybrid)
strategy_9 <- function(df, first_dose_data, second_dose_data, next_year_dose_data, realistic_ind){
  
  #Assign who is getting vaccinated using age-specific and risk-specific coverage rates
  # NOTE: `vax_1`, `vax_2`, `vax_3` assigns who will get 1st, 2nd, or 3rd doses based on assumed coverage rates.
  #       `vaccine_wave`, `second_vaccine_wave`, `third_vaccine_wave` assigns when those doses are administered based on assumed uptake
  vax_assignment <- df %>% mutate(vax_1 = 0, vax_2 = 0, vax_3 = 0, vaccine_wave = 0, second_vaccine_wave = 0, third_vaccine_wave = 0)
  
  #Pull coverage rates from first and second dose data
  first_dose_coverage <- (first_dose_data %>% filter(week == 52) %>% arrange(age_group, risk_group))$risk_coverage/100
  second_dose_coverage <- (second_dose_data %>% filter(week == 52) %>% arrange(age_group, risk_group))$coverage/100
  
  #For 0-17 years age bin, assume that 96.7% of 0-17 years are older than 6 months (CRUDE ASSUMPTION)
  age_0_17_index <- which(vax_assignment$age_group == "0-17 years")
  age_0_17_index <- sample(age_0_17_index, length(age_0_17_index) * 0.967)
  
  age_18_29_index <- which(vax_assignment$age_group == "18-29 years")
  age_30_49_index <- which(vax_assignment$age_group == "30-49 years")
  age_50_64_index <- which(vax_assignment$age_group == "50-64 years")
  age_65_74_index <- which(vax_assignment$age_group == "65-74 years")
  age_75_plus_index <- which(vax_assignment$age_group == "75+ years")
  
  risk_healthy_index <- which(vax_assignment$risk_group == "healthy")
  risk_highrisk_index <- which(vax_assignment$risk_group == "higher risk")
  risk_immuno_index <- which(vax_assignment$risk_group == "immunocompromised")
  
  prev_vaccinated <- which(vax_assignment$prior_vacc != "unvax")
  
  vax_assignment$vax_1[Reduce(intersect, list(age_18_29_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[4] * length(Reduce(intersect, list(age_18_29_index,risk_healthy_index)))/length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,prev_vaccinated))), 1, if_else(first_dose_coverage[5] * length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,prev_vaccinated))) > 1, 1, first_dose_coverage[5] * length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,prev_vaccinated)))))
  vax_assignment$vax_1[Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated))), 1, if_else(first_dose_coverage[6] * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated))) > 1, 1, first_dose_coverage[6] * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,prev_vaccinated)))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[7] * length(Reduce(intersect, list(age_30_49_index,risk_healthy_index)))/length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated))), 1, if_else(first_dose_coverage[8] * length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated))) > 1, 1, first_dose_coverage[8] * length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated)))))
  vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))), 1, if_else(first_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))) > 1, 1, first_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated)))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[10] * length(Reduce(intersect, list(age_50_64_index,risk_healthy_index)))/length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[11] * length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[12] * length(Reduce(intersect, list(age_50_64_index,risk_immuno_index)))/length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[13] * length(Reduce(intersect, list(age_65_74_index,risk_healthy_index)))/length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[14] * length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[15] * length(Reduce(intersect, list(age_65_74_index,risk_immuno_index)))/length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[16] * length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[17] * length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[18] * length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))))
  
  print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
  print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
  print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
  print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
  print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
  print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
  
  print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy"))* 0.967)))
  print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
  
  print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
  print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
  
  print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
  print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
  
  #Assign who is getting the second vaccine dose 
  # NOTE: Only individuals who have already been assigned with receiving the first vaccine dose `vax_1` are eligible for the second vaccine dose. Since we are sampling only
  #       from individuals who have been assigned first vaccine dose but we are trying to hit the age/risk-specific coverage targets for the entire age/risk group 
  #       (including those who aren't eligible for the second dose), we adjust the coverage upwards for the probability in the rbinom function.
  second_dose_eligible <- which(vax_assignment$vax_1 == 1)
  
  vax_assignment$vax_2[Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))), 1, if_else(second_dose_coverage[6] * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))) > 1, 1, second_dose_coverage[6] * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible)))))
  
  vax_assignment$vax_2[Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))), 1, if_else(second_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))) > 1, 1, second_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible)))))
  
  vax_assignment$vax_2[Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))), 1, if_else(second_dose_coverage[12] * length(Reduce(intersect, list(age_50_64_index,risk_immuno_index)))/length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))) > 1, 1, second_dose_coverage[12] * length(Reduce(intersect, list(age_50_64_index,risk_immuno_index)))/length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible)))))
  
  vax_assignment$vax_2[Reduce(intersect, list(age_65_74_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,second_dose_eligible))), 1, if_else(second_dose_coverage[13] * length(Reduce(intersect, list(age_65_74_index)))/length(Reduce(intersect, list(age_65_74_index,second_dose_eligible))) > 1, 1, second_dose_coverage[13] * length(Reduce(intersect, list(age_65_74_index)))/length(Reduce(intersect, list(age_65_74_index,second_dose_eligible)))))
  vax_assignment$vax_2[Reduce(intersect, list(age_75_plus_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,second_dose_eligible))), 1, if_else(second_dose_coverage[16] * length(Reduce(intersect, list(age_75_plus_index)))/length(Reduce(intersect, list(age_75_plus_index,second_dose_eligible))) > 1, 1, second_dose_coverage[16] * length(Reduce(intersect, list(age_75_plus_index)))/length(Reduce(intersect, list(age_75_plus_index,second_dose_eligible)))))
  
  print(paste0("Percentage of immunocompromised receiving second dose: ",  length(which(vax_assignment$risk_group %in% c("immunocompromised") & vax_assignment$vax_2 == 1))/length(which(vax_assignment$risk_group %in% c("immunocompromised")))))
  print(paste0("Percentage of 65-74 years receiving second dose: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_2 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
  print(paste0("Percentage of 75+ years receiving second dose: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_2 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
  
  #distribute first vaccine dose over first 365 days, according to age-specific distribution of assumed coverage
  to_vaccinate_index <- which(vax_assignment$vax_1 == 1)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  #distribute second dose booster uptake over next 365 days, according to age distributions
  to_vaccinate_second_index <- which(vax_assignment$vax_2 == 1)
  
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  #For assignment of annual dose in year 2 of simulation, uptake assignment code differs depending on if assumed coverage is HISTORIC vs. OPTIMISTIC/PESSIMISTIC.
  # NOTE: If coverage is HISTORIC (`realistic_ind == 1`), then vaccine assignment for annual dose in year 2 is done more carefully since historic coverage is different in year 1 vs. 2.
  #       If coverage is OPTIMISTIC/PESSIMISTIC (`realistic_ind == 0`), then all individuals assigned to receive annual dose in year 1 are re-assigned to receive annual dose in year 2.
  if(realistic_ind == 1) {
    
    #Assign who will receive the updated booster (validation period)
    third_dose_eligible <- which(vax_assignment$vax_2 == 1)
  
    vax_assignment$vax_3[Reduce(intersect, list(age_18_29_index,risk_healthy_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,second_dose_eligible))), 1, 0.0758 * length(Reduce(intersect, list(age_18_29_index,risk_healthy_index)))/length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,second_dose_eligible))))
    vax_assignment$vax_3[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,third_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,second_dose_eligible)), third_dose_eligible), round(length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index)))  * (0.1521 + 0.05 - 0.054)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_18_29_index,risk_immuno_index,third_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible)), third_dose_eligible), round(length(Reduce(intersect, list(age_18_29_index,risk_immuno_index))) * (0.1521 - 0.054)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_30_49_index,risk_healthy_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,second_dose_eligible))), 1, 0.121 * length(Reduce(intersect, list(age_30_49_index,risk_healthy_index)))/length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,second_dose_eligible))))
    vax_assignment$vax_3[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index))) * (0.2428 - 0.2355)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_30_49_index,risk_immuno_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_30_49_index,risk_immuno_index))) * (0.2428 - 0.2355)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_50_64_index,risk_healthy_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_50_64_index,risk_healthy_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_50_64_index,risk_healthy_index))) * (0.1471 - 0.1439)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_50_64_index,risk_highrisk_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index))) * (0.2953 - 0.2591)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_50_64_index,risk_immuno_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_50_64_index,risk_immuno_index))) * (0.2953 - 0.2591)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_healthy_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_healthy_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_healthy_index)),second_dose_eligible)) * (0.2334 - 0.2228)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)),second_dose_eligible)) * (0.4685 - 0.3710)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_immuno_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_immuno_index)),second_dose_eligible)) * (0.4685 - 0.3710)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)),second_dose_eligible)) * (0.254 - 0.221)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)),second_dose_eligible)) * (0.5097 - 0.3379)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)),second_dose_eligible)) * (0.5097 - 0.3379)))] <- 1
    
    print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
    print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
    print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
    print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
    print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
    print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
    
    print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy")) * 0.967)))
    print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
    
    print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
    print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
    
    print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
    print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
    
    #distribute vaccine uptake over last 182 days, according to age distributions
    to_vaccinate_third_index <- which(vax_assignment$vax_3 == 1)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_18_29_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "18-29 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_18_29_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "18-29 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "30-49 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
  } 
  
  if(realistic_ind == 0){
    print("Optimistic or Pessimistic uptake")
    vax_assignment$vax_3 <- vax_assignment$vax_1
    vax_assignment$third_vaccine_wave <- if_else(vax_assignment$vax_3 == 1, vax_assignment$vaccine_wave + 365, 0)
    
    print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
    print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
    print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
    print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
    print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
    print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
    
    print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy"))* 0.967)))
    print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
    
    print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
    print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
    
    print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
    print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
  }
  
  return(vax_assignment %>% arrange(individual))
}

#Strategy 10: Universal (Strategy 3) with second dose in key risk group (Strategy 5) - (Hybrid)
strategy_10 <- function(df, first_dose_data, second_dose_data, next_year_dose_data, realistic_ind){
  
  #Assign who is getting vaccinated using age-specific and risk-specific coverage rates
  # NOTE: `vax_1`, `vax_2`, `vax_3` assigns who will get 1st, 2nd, or 3rd doses based on assumed coverage rates.
  #       `vaccine_wave`, `second_vaccine_wave`, `third_vaccine_wave` assigns when those doses are administered based on assumed uptake
  vax_assignment <- df %>% mutate(vax_1 = 0, vax_2 = 0, vax_3 = 0, vaccine_wave = 0, second_vaccine_wave = 0, third_vaccine_wave = 0)
  
  #Pull coverage rates from first and second dose data
  first_dose_coverage <- (first_dose_data %>% filter(week == 52) %>% arrange(age_group, risk_group))$risk_coverage/100
  second_dose_coverage <- (second_dose_data %>% filter(week == 52) %>% arrange(age_group, risk_group))$coverage/100
  
  #For 0-17 years age bin, assume that 96.7% of 0-17 years are older than 6 months (CRUDE ASSUMPTION)
  age_0_17_index <- which(vax_assignment$age_group == "0-17 years")
  age_0_17_index <- sample(age_0_17_index, length(age_0_17_index) * 0.967)
  
  age_18_29_index <- which(vax_assignment$age_group == "18-29 years")
  age_30_49_index <- which(vax_assignment$age_group == "30-49 years")
  age_50_64_index <- which(vax_assignment$age_group == "50-64 years")
  age_65_74_index <- which(vax_assignment$age_group == "65-74 years")
  age_75_plus_index <- which(vax_assignment$age_group == "75+ years")
  
  risk_healthy_index <- which(vax_assignment$risk_group == "healthy")
  risk_highrisk_index <- which(vax_assignment$risk_group == "higher risk")
  risk_immuno_index <- which(vax_assignment$risk_group == "immunocompromised")
  
  prev_vaccinated <- which(vax_assignment$prior_vacc != "unvax")
  
  vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[7] * length(Reduce(intersect, list(age_30_49_index,risk_healthy_index)))/length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated))), 1, if_else(first_dose_coverage[8] * length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated))) > 1, 1, first_dose_coverage[8] * length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,prev_vaccinated)))))
  vax_assignment$vax_1[Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))), 1, if_else(first_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated))) > 1, 1, first_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,prev_vaccinated)))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[10] * length(Reduce(intersect, list(age_50_64_index,risk_healthy_index)))/length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[11] * length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[12] * length(Reduce(intersect, list(age_50_64_index,risk_immuno_index)))/length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,prev_vaccinated))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[13] * length(Reduce(intersect, list(age_65_74_index,risk_healthy_index)))/length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[14] * length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[15] * length(Reduce(intersect, list(age_65_74_index,risk_immuno_index)))/length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,prev_vaccinated))))
  
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))), 1, first_dose_coverage[16] * length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))), 1, first_dose_coverage[17] * length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,prev_vaccinated))))
  vax_assignment$vax_1[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))), 1, first_dose_coverage[18] * length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)))/length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,prev_vaccinated))))
  
  print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
  print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
  print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
  print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
  print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
  print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
  
  print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy"))* 0.967)))
  print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
  print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
  
  print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
  print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
  print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
  
  print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
  print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
  print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_1 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
  
  #Assign who is getting the second vaccine dose 
  # NOTE: Only individuals who have already been assigned with receiving the first vaccine dose `vax_1` are eligible for the second vaccine dose. Since we are sampling only
  #       from individuals who have been assigned first vaccine dose but we are trying to hit the age/risk-specific coverage targets for the entire age/risk group 
  #       (including those who aren't eligible for the second dose), we adjust the coverage upwards for the probability in the rbinom function.
  second_dose_eligible <- which(vax_assignment$vax_1 == 1)
  
  vax_assignment$vax_2[Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))), 1, if_else(second_dose_coverage[6] * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible))) > 1, 1, second_dose_coverage[6] * length(Reduce(intersect, list(age_18_29_index,risk_immuno_index)))/length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,second_dose_eligible)))))
  
  vax_assignment$vax_2[Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))), 1, if_else(second_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))) > 1, 1, second_dose_coverage[9] * length(Reduce(intersect, list(age_30_49_index,risk_immuno_index)))/length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible)))))
  
  vax_assignment$vax_2[Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))), 1, if_else(second_dose_coverage[12] * length(Reduce(intersect, list(age_50_64_index,risk_immuno_index)))/length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))) > 1, 1, second_dose_coverage[12] * length(Reduce(intersect, list(age_50_64_index,risk_immuno_index)))/length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible)))))
  
  vax_assignment$vax_2[Reduce(intersect, list(age_65_74_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_65_74_index,second_dose_eligible))), 1, if_else(second_dose_coverage[13] * length(Reduce(intersect, list(age_65_74_index)))/length(Reduce(intersect, list(age_65_74_index,second_dose_eligible))) > 1, 1, second_dose_coverage[13] * length(Reduce(intersect, list(age_65_74_index)))/length(Reduce(intersect, list(age_65_74_index,second_dose_eligible)))))
  vax_assignment$vax_2[Reduce(intersect, list(age_75_plus_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_75_plus_index,second_dose_eligible))), 1, if_else(second_dose_coverage[16] * length(Reduce(intersect, list(age_75_plus_index)))/length(Reduce(intersect, list(age_75_plus_index,second_dose_eligible))) > 1, 1, second_dose_coverage[16] * length(Reduce(intersect, list(age_75_plus_index)))/length(Reduce(intersect, list(age_75_plus_index,second_dose_eligible)))))
  
  print(paste0("Percentage of immunocompromised receiving second dose: ",  length(which(vax_assignment$risk_group %in% c("immunocompromised") & vax_assignment$vax_2 == 1))/length(which(vax_assignment$risk_group %in% c("immunocompromised")))))
  print(paste0("Percentage of 65-74 years receiving second dose: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_2 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
  print(paste0("Percentage of 75+ years receiving second dose: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_2 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
  
  #distribute first vaccine dose over first 365 days, according to age-specific distribution of assumed coverage
  to_vaccinate_index <- which(vax_assignment$vax_1 == 1)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_index))] <- sample(c(1:365), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_index))), prob = c(((first_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period)[1], rep((first_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  #distribute second dose booster uptake over next 365 days, according to age distributions
  to_vaccinate_second_index <- which(vax_assignment$vax_2 == 1)
  
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_18_29_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "18-29 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  vax_assignment$second_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_second_index))] <- sample(c(240:365), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_second_index))), prob = c(rep((second_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
  
  #For assignment of annual dose in year 2 of simulation, uptake assignment code differs depending on if assumed coverage is HISTORIC vs. OPTIMISTIC/PESSIMISTIC.
  # NOTE: If coverage is HISTORIC (`realistic_ind == 1`), then vaccine assignment for annual dose in year 2 is done more carefully since historic coverage is different in year 1 vs. 2.
  #       If coverage is OPTIMISTIC/PESSIMISTIC (`realistic_ind == 0`), then all individuals assigned to receive annual dose in year 1 are re-assigned to receive annual dose in year 2.
  if(realistic_ind == 1) {
    
    #Assign who will receive the updated booster (validation period)
    third_dose_eligible <- which(vax_assignment$vax_2 == 1)
    
    vax_assignment$vax_3[Reduce(intersect, list(age_30_49_index,risk_healthy_index,second_dose_eligible))] <- rbinom(length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,second_dose_eligible))), 1, 0.121 * length(Reduce(intersect, list(age_30_49_index,risk_healthy_index)))/length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,second_dose_eligible))))
    vax_assignment$vax_3[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_30_49_index,risk_highrisk_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index))) * (0.2428 - 0.2355)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_30_49_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_30_49_index,risk_immuno_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_30_49_index,risk_immuno_index))) * (0.2428 - 0.2355)))] <- 1
    
    
    vax_assignment$vax_3[Reduce(intersect, list(age_50_64_index,risk_healthy_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_50_64_index,risk_healthy_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_50_64_index,risk_healthy_index))) * (0.1471 - 0.1439)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_50_64_index,risk_highrisk_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index))) * (0.2953 - 0.2591)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_50_64_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_50_64_index,risk_immuno_index)),second_dose_eligible), round(length(Reduce(intersect, list(age_50_64_index,risk_immuno_index))) * (0.2953 - 0.2591)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_healthy_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_healthy_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_healthy_index)),second_dose_eligible)) * (0.2334 - 0.2228)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_highrisk_index)),second_dose_eligible)) * (0.4685 - 0.3710)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_65_74_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_65_74_index,risk_immuno_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_65_74_index,risk_immuno_index)),second_dose_eligible)) * (0.4685 - 0.3710)))] <- 1
    
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_healthy_index)),second_dose_eligible)) * (0.254 - 0.221)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index)),second_dose_eligible)) * (0.5097 - 0.3379)))] <- 1
    vax_assignment$vax_3[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,second_dose_eligible))] <- 1
    vax_assignment$vax_3[sample(setdiff(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)),second_dose_eligible), round(length(setdiff(Reduce(intersect, list(age_75_plus_index,risk_immuno_index)),second_dose_eligible)) * (0.5097 - 0.3379)))] <- 1
    
    print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
    print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
    print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
    print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
    print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
    print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
    
    print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy")) * 0.967)))
    print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
    
    print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
    print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
    
    print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
    print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
    
    #distribute vaccine uptake over last 182 days, according to age distributions
    to_vaccinate_third_index <- which(vax_assignment$vax_3 == 1)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_30_49_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "30-49 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_30_49_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "30-49 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_30_49_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "30-49 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_50_64_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "50-64 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_65_74_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "65-74 years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_healthy_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "healthy") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_highrisk_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "higher risk") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    vax_assignment$third_vaccine_wave[Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_third_index))] <- sample(c((1 + 365):(182 + 365)), length(Reduce(intersect, list(age_75_plus_index,risk_immuno_index,to_vaccinate_third_index))), prob = c(rep((next_year_dose_data %>% filter(age_group == "75+ years", risk_group == "immunocompromised") %>% arrange(week))$prop_up_to_date_sim_period, each = 7)), replace = TRUE)
    
  } 
  
  if(realistic_ind == 0){
    print("Optimistic or Pessimistic uptake")
    vax_assignment$vax_3 <- vax_assignment$vax_1
    vax_assignment$third_vaccine_wave <- if_else(vax_assignment$vax_3 == 1, vax_assignment$vaccine_wave + 365, 0)
    
    print(paste0("Percentage of 0-17 years receiving vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years"))* 0.967)))
    print(paste0("Percentage of 18-29 years receiving vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years"))))
    print(paste0("Percentage of 30-49 years receiving vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years"))))
    print(paste0("Percentage of 50-64 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years"))))
    print(paste0("Percentage of 65-74 years receiving vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years"))))
    print(paste0("Percentage of 75+ years receiving vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years"))))
    
    print(paste0("0-17 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "healthy"))* 0.967)))
    print(paste0("18-29 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("30-49 years, healthy: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("50-64 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("65-74 years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "healthy"))))
    print(paste0("75+ years, healthy: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "healthy"))))
    
    print(paste0("0-17 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "higher risk"))* 0.967)))
    print(paste0("18-29 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("30-49 years, higher risk: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("50-64 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("65-74 years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "higher risk"))))
    print(paste0("75+ years, higher risk: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "higher risk"))))
    
    print(paste0("0-17 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/(length(which(vax_assignment$age_group == "0-17 years" & vax_assignment$risk_group == "immunocompromised"))* 0.967)))
    print(paste0("18-29 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "18-29 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("30-49 years, immunocompromised: % vaccinated: ", length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "30-49 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("50-64 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "50-64 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("65-74 years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "65-74 years" & vax_assignment$risk_group == "immunocompromised"))))
    print(paste0("75+ years, immunocompromised: % vaccinated: ",  length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised" & vax_assignment$vax_3 == 1))/length(which(vax_assignment$age_group == "75+ years" & vax_assignment$risk_group == "immunocompromised"))))
  }
  
  return(vax_assignment %>% arrange(individual))
}
